<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="NCAR HPC Docs website"><meta name=author content="CISL CSG (Consulting Services Group)"><link href=https://NCAR.github.io/HPC-Docs/environment-and-software/user-environment/containers/examples/ rel=canonical><link rel=icon href="https://t0.gstatic.com/faviconV2?client=SOCIAL&type=FAVICON&fallback_opts=TYPE,SIZE,URL&url=https://arc.ucar.edu/knowledge_base/83853599"><meta name=generator content="mkdocs-1.5.3, mkdocs-material-8.5.10"><title>NCAR HPC Documentation</title><link rel=stylesheet href=../../../../assets/stylesheets/main.975780f9.min.css><link rel=stylesheet href=../../../../assets/stylesheets/palette.2505c338.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Poppins:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Poppins";--md-code-font:"Roboto Mono"}</style><link rel=stylesheet href=../../../../css/timeago.css><link rel=stylesheet href=../../../../stylesheets/extra.css><script>__md_scope=new URL("../../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script><link href=../../../../assets/stylesheets/glightbox.min.css rel=stylesheet><style>
        html.glightbox-open { overflow: initial; height: 100%; }
        .gslide-title { margin-top: 0px; user-select: text; }
        .gslide-desc { color: #666; user-select: text; }
        .gslide-image img { background: white; }
        
            .gscrollbar-fixer { padding-right: 15px; }
            .gdesc-inner { font-size: 0.75rem; }
            body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color);}
            body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color);}
            body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color);}
            </style><script src=../../../../assets/javascripts/glightbox.min.js></script></head> <body dir=ltr data-md-color-scheme=cisl_default data-md-color-primary data-md-color-accent> <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#sample-containerized-workflows class=md-skip> Skip to content </a> </div> <div data-md-component=announce> <aside class=md-banner> <div class="md-banner__inner md-grid md-typeset"> <button class="md-banner__button md-icon" aria-label="Don't show this again"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg> </button> <strong>This site is currently under ACTIVE DEVELOPMENT!</strong> </div> <script>var content,el=document.querySelector("[data-md-component=announce]");el&&(content=el.querySelector(".md-typeset"),__md_hash(content.innerHTML)===__md_get("__announce")&&(el.hidden=!0))</script> </aside> </div> <header class=md-header data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=../../../.. title="NCAR HPC Documentation" class="md-header__button md-logo" aria-label="NCAR HPC Documentation" data-md-component=logo> <img src=../../../../assets/images/CISL-contemp-logo-blue-square.png alt=logo> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> NCAR HPC Documentation </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> Example Workflows </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media data-md-color-scheme=cisl_default data-md-color-primary data-md-color-accent aria-label="Switch to dark mode" type=radio name=__palette id=__palette_1> <label class="md-header__button md-icon" title="Switch to dark mode" for=__palette_2 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6zm0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4zM7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg> </label> <input class=md-option data-md-color-media data-md-color-scheme=cisl_default_dark data-md-color-primary data-md-color-accent aria-label="Switch to light mode" type=radio name=__palette id=__palette_2> <label class="md-header__button md-icon" title="Switch to light mode" for=__palette_1 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3Z"/></svg> </label> </form> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg> </label> <nav class=md-search__options aria-label=Search> <a href=javascript:void(0) class="md-search__icon md-icon" title=Share aria-label=Share data-clipboard data-clipboard-text data-md-component=search-share tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7 0-.24-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91 1.61 0 2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08Z"/></svg> </a> <button type=reset class="md-search__icon md-icon" title=Clear aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg> </button> </nav> <div class=md-search__suggest data-md-component=search-suggest></div> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/NCAR/HPC-Docs/ title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 496 512"><!-- Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg> </div> <div class=md-source__repository> GitHub </div> </a> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../../../.. title="NCAR HPC Documentation" class="md-nav__button md-logo" aria-label="NCAR HPC Documentation" data-md-component=logo> <img src=../../../../assets/images/CISL-contemp-logo-blue-square.png alt=logo> </a> NCAR HPC Documentation </label> <div class=md-nav__source> <a href=https://github.com/NCAR/HPC-Docs/ title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 496 512"><!-- Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg> </div> <div class=md-source__repository> GitHub </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../.. class=md-nav__link> Home </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2 type=checkbox id=__nav_2> <div class="md-nav__link md-nav__link--index "> <a href=../../../../getting-started/ >Getting Started</a> <label for=__nav_2> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav aria-label="Getting Started" data-md-level=1> <label class=md-nav__title for=__nav_2> <span class="md-nav__icon md-icon"></span> Getting Started </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../getting-started/user-responsibilities/ class=md-nav__link> User Responsibilities </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2_3 type=checkbox id=__nav_2_3> <div class="md-nav__link md-nav__link--index "> <a href=../../../../getting-started/accounts/ >Accounts</a> <label for=__nav_2_3> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav aria-label=Accounts data-md-level=2> <label class=md-nav__title for=__nav_2_3> <span class="md-nav__icon md-icon"></span> Accounts </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../getting-started/accounts/cit-passwords/ class=md-nav__link> CIT Passwords </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2_3_3 type=checkbox id=__nav_2_3_3> <div class="md-nav__link md-nav__link--index "> <a href=../../../../getting-started/accounts/duo/ >Duo Two-Factor Authentication</a> <label for=__nav_2_3_3> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav aria-label="Duo Two-Factor Authentication" data-md-level=3> <label class=md-nav__title for=__nav_2_3_3> <span class="md-nav__icon md-icon"></span> Duo Two-Factor Authentication </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../getting-started/accounts/duo/enrolling/ class=md-nav__link> Enrolling with Duo </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../../../getting-started/accounts/systems-accounting-manager/ class=md-nav__link> SAM </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2_4 type=checkbox id=__nav_2_4> <div class="md-nav__link md-nav__link--index "> <a href=../../../../allocations/ >Allocations</a> <label for=__nav_2_4> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav aria-label=Allocations data-md-level=2> <label class=md-nav__title for=__nav_2_4> <span class="md-nav__icon md-icon"></span> Allocations </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../getting-started/managing-your-allocation/ class=md-nav__link> Managing Your Allocation </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2_4_3 type=checkbox id=__nav_2_4_3> <div class="md-nav__link md-nav__link--index "> <a href=../../../../allocations/ncar-allocations/ >NCAR Allocations</a> <label for=__nav_2_4_3> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav aria-label="NCAR Allocations" data-md-level=3> <label class=md-nav__title for=__nav_2_4_3> <span class="md-nav__icon md-icon"></span> NCAR Allocations </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../allocations/ncar-allocations/ncar-strategic-capability-nsc-projects/ class=md-nav__link> NCAR Strategic Capability (NSC) projects </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2_4_4 type=checkbox id=__nav_2_4_4> <div class="md-nav__link md-nav__link--index "> <a href=../../../../allocations/university-allocations/ >University Allocations</a> <label for=__nav_2_4_4> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav aria-label="University Allocations" data-md-level=3> <label class=md-nav__title for=__nav_2_4_4> <span class="md-nav__icon md-icon"></span> University Allocations </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../allocations/university-allocations/university-large-allocation-request-preparation-instructions/ class=md-nav__link> University Large Allocation Request Preparation Instructions </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../../../allocations/determining-computational-resource-needs/ class=md-nav__link> Determining computational resource needs </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2_4_6 type=checkbox id=__nav_2_4_6> <div class="md-nav__link md-nav__link--index "> <a href=../../../../allocations/chap/ >CISL HPC Allocations Panel</a> <label for=__nav_2_4_6> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav aria-label="CISL HPC Allocations Panel" data-md-level=3> <label class=md-nav__title for=__nav_2_4_6> <span class="md-nav__icon md-icon"></span> CISL HPC Allocations Panel </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../allocations/chap/chap-allocation-review-criteria/ class=md-nav__link> Allocation Review Criteria </a> </li> <li class=md-nav__item> <a href=../../../../allocations/chap/chap-conflict-of-interest-policy/ class=md-nav__link> Conflict of Interest Policy </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../../../getting-started/vpn-access/ class=md-nav__link> VPN access </a> </li> <li class=md-nav__item> <a href=../../../../getting-started/system-usage-policies/ class=md-nav__link> System Usage Policies </a> </li> <li class=md-nav__item> <a href=../../../../getting-started/data-retention-policies/ class=md-nav__link> Data Retention Policies </a> </li> <li class=md-nav__item> <a href=../../../../getting-started/best-practices-for-supercomputer-users/ class=md-nav__link> Best Practices for Supercomputer Users </a> </li> <li class=md-nav__item> <a href=../../../../getting-started/acknowledging-ncar-and-cisl/ class=md-nav__link> Acknowledging NCAR and CISL </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_3 type=checkbox id=__nav_3> <div class="md-nav__link md-nav__link--index "> <a href=../../../../storage-systems/ >Storage Systems and Data Transfer</a> <label for=__nav_3> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav aria-label="Storage Systems and Data Transfer" data-md-level=1> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> Storage Systems and Data Transfer </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_3_2 type=checkbox id=__nav_3_2> <div class="md-nav__link md-nav__link--index "> <a href=../../../../storage-systems/glade/ >GLADE (POSIX File Systems)</a> <label for=__nav_3_2> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav aria-label="GLADE (POSIX File Systems)" data-md-level=2> <label class=md-nav__title for=__nav_3_2> <span class="md-nav__icon md-icon"></span> GLADE (POSIX File Systems) </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../storage-systems/glade/campaign/ class=md-nav__link> Campaign storage file system </a> </li> <li class=md-nav__item> <a href=../../../../storage-systems/glade/lustre/ class=md-nav__link> Lustre file systems </a> </li> <li class=md-nav__item> <a href=../../../../storage-systems/glade/setting-file-directory-permissions/ class=md-nav__link> Setting File and Directory Permissions </a> </li> <li class=md-nav__item> <a href=../../../../storage-systems/glade/using-access-control-lists/ class=md-nav__link> Using Access Control Lists </a> </li> <li class=md-nav__item> <a href=../../../../storage-systems/glade/recovering-files-from-snapshots/ class=md-nav__link> Recovering files from snapshots </a> </li> <li class=md-nav__item> <a href=../../../../storage-systems/glade/removing-large-number-of-files/ class=md-nav__link> Removing large number of files </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_3_3 type=checkbox id=__nav_3_3> <div class="md-nav__link md-nav__link--index "> <a href=../../../../storage-systems/quasar/ >Quasar (Tape Storgae)</a> <label for=__nav_3_3> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav aria-label="Quasar (Tape Storgae)" data-md-level=2> <label class=md-nav__title for=__nav_3_3> <span class="md-nav__icon md-icon"></span> Quasar (Tape Storgae) </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../storage-systems/quasar/quasar%2Bsystem%2Bspecifications/ class=md-nav__link> Quasar system specifications </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_3_4 type=checkbox id=__nav_3_4> <div class="md-nav__link md-nav__link--index "> <a href=../../../../storage-systems/stratus/ >Stratus (Object Storage)</a> <label for=__nav_3_4> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav aria-label="Stratus (Object Storage)" data-md-level=2> <label class=md-nav__title for=__nav_3_4> <span class="md-nav__icon md-icon"></span> Stratus (Object Storage) </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../storage-systems/stratus/getting-started-with-an-object-storage-admin-account/ class=md-nav__link> Getting started with an object storage admin account </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../../../storage-systems/data-access-nodes/ class=md-nav__link> Data Access Nodes </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_3_6 type=checkbox id=__nav_3_6> <div class="md-nav__link md-nav__link--index "> <a href=../../../../storage-systems/data-transfer/ >Transferring Data</a> <label for=__nav_3_6> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav aria-label="Transferring Data" data-md-level=2> <label class=md-nav__title for=__nav_3_6> <span class="md-nav__icon md-icon"></span> Transferring Data </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_3_6_2 type=checkbox id=__nav_3_6_2> <div class="md-nav__link md-nav__link--index "> <a href=../../../../storage-systems/data-transfer/globus/ >Globus</a> <label for=__nav_3_6_2> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav aria-label=Globus data-md-level=3> <label class=md-nav__title for=__nav_3_6_2> <span class="md-nav__icon md-icon"></span> Globus </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../storage-systems/data-transfer/globus/Sharing%2Bdata%2Band%2Bmaking%2Bunattended%2Btransfers/ class=md-nav__link> Sharing data and making unattended transfers </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../../../storage-systems/data-transfer/scp-and-sftp/ class=md-nav__link> SCP, SFTP and other tools </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../../../storage-systems/cmip-analysis-platform/ class=md-nav__link> CMIP Analysis Platform </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_4 type=checkbox id=__nav_4 checked> <div class="md-nav__link md-nav__link--index "> <a href=../../../ >User Environment and HPC Software</a> <label for=__nav_4> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav aria-label="User Environment and HPC Software" data-md-level=1> <label class=md-nav__title for=__nav_4> <span class="md-nav__icon md-icon"></span> User Environment and HPC Software </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_4_2 type=checkbox id=__nav_4_2 checked> <div class="md-nav__link md-nav__link--index "> <a href=../../ >User Environment</a> <label for=__nav_4_2> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav aria-label="User Environment" data-md-level=2> <label class=md-nav__title for=__nav_4_2> <span class="md-nav__icon md-icon"></span> User Environment </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../modules/ class=md-nav__link> Modules </a> </li> <li class=md-nav__item> <a href=../../conda/ class=md-nav__link> Conda </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_4_2_4 type=checkbox id=__nav_4_2_4 checked> <div class="md-nav__link md-nav__link--index "> <a href=../ >Containers</a> <label for=__nav_4_2_4> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav aria-label=Containers data-md-level=3> <label class=md-nav__title for=__nav_4_2_4> <span class="md-nav__icon md-icon"></span> Containers </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../working_with_containers/ class=md-nav__link> Working with Containers </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" data-md-toggle=toc type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> Example Workflows <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> Example Workflows </a> <nav class="md-nav md-nav--secondary" aria-label="Page Outline"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Page Outline </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#nvidias-ngc-containers class=md-nav__link> NVIDIA's NGC containers </a> <nav class=md-nav aria-label="NVIDIA's NGC containers"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#nvidias-modulus-physics-ml-framework class=md-nav__link> NVIDIA's Modulus physics-ML framework </a> </li> <li class=md-nav__item> <a href=#popular-aiml-tools class=md-nav__link> Popular AI/ML tools </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#building-and-running-containerized-fasteddy-under-mpi-on-gpus class=md-nav__link> Building and running containerized FastEddy under MPI on GPUs </a> <nav class=md-nav aria-label="Building and running containerized FastEddy under MPI on GPUs"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#about-fasteddy class=md-nav__link> About FastEddy </a> </li> <li class=md-nav__item> <a href=#containerization-approach class=md-nav__link> Containerization approach </a> </li> <li class=md-nav__item> <a href=#building-the-image class=md-nav__link> Building the image </a> <nav class=md-nav aria-label="Building the image"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#the-base-layer class=md-nav__link> The base layer </a> </li> <li class=md-nav__item> <a href=#adding-cuda-cuda-aware-mpich class=md-nav__link> Adding CUDA &amp; CUDA-aware MPICH </a> </li> <li class=md-nav__item> <a href=#building-fasteddy class=md-nav__link> Building FastEddy </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#running-the-container-on-derecho class=md-nav__link> Running the container on Derecho </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../utilities/ class=md-nav__link> Utilities </a> </li> <li class=md-nav__item> <a href=../../customizing/ class=md-nav__link> Customizing User Environment </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_4_2_7 type=checkbox id=__nav_4_2_7> <div class="md-nav__link md-nav__link--index "> <a href=../../spack/ >Spack</a> <label for=__nav_4_2_7> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav aria-label=Spack data-md-level=3> <label class=md-nav__title for=__nav_4_2_7> <span class="md-nav__icon md-icon"></span> Spack </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../spack/spack-downstream/ class=md-nav__link> Spack Downstream </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_4_3 type=checkbox id=__nav_4_3> <div class="md-nav__link md-nav__link--index "> <a href=../../../hpc-software/ >HPC Software</a> <label for=__nav_4_3> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav aria-label="HPC Software" data-md-level=2> <label class=md-nav__title for=__nav_4_3> <span class="md-nav__icon md-icon"></span> HPC Software </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../community-models/ class=md-nav__link> Community Models </a> </li> <li class=md-nav__item> <a href=../../../data-analysis-and-visualization/ class=md-nav__link> Data Analysis and Visualization </a> </li> <li class=md-nav__item> <a href=../../../ncl/ class=md-nav__link> NCL </a> </li> <li class=md-nav__item> <a href=../../../matlab-parallel-computing-toolbox/ class=md-nav__link> MATLAB Parallel Computing Toolbox </a> </li> <li class=md-nav__item> <a href=../../../numerical-libraries/ class=md-nav__link> Numerical Libraries </a> </li> <li class=md-nav__item> <a href=../../../machine-learning-and-deep-learning/ class=md-nav__link> Machine Learning and Deep Learning </a> </li> <li class=md-nav__item> <a href=../../../ncar-classic-libraries-for-geophysics/ class=md-nav__link> NCAR Classic Libraries for Geophysics </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_4_3_9 type=checkbox id=__nav_4_3_9> <label class=md-nav__link for=__nav_4_3_9> Profiling & Debuggers <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Profiling & Debuggers" data-md-level=3> <label class=md-nav__title for=__nav_4_3_9> <span class="md-nav__icon md-icon"></span> Profiling & Debuggers </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../hpc-software/profiling-and-debuggers/running-ddt-map-and-pr-jobs/ class=md-nav__link> Debugging and Profiling with Forge Tools </a> </li> <li class=md-nav__item> <a href=../../../hpc-software/profiling-and-debuggers/intel-parallel-studio-xe/ class=md-nav__link> Intel Parallel Studio XE </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_4_3_10 type=checkbox id=__nav_4_3_10> <div class="md-nav__link md-nav__link--index "> <a href=../../../benchmarks/ >Benchmarks</a> <label for=__nav_4_3_10> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav aria-label=Benchmarks data-md-level=3> <label class=md-nav__title for=__nav_4_3_10> <span class="md-nav__icon md-icon"></span> Benchmarks </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../benchmarks/ncar-benchmarking-2015/ class=md-nav__link> NCAR Benchmarking applications - 2015 release </a> </li> <li class=md-nav__item> <a href=../../../benchmarks/ncar-benchmarking-2019-2020/ class=md-nav__link> NCAR Benchmarking applications - 2019-2020 release </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_5 type=checkbox id=__nav_5> <label class=md-nav__link for=__nav_5> Compute Systems and Services <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Compute Systems and Services" data-md-level=1> <label class=md-nav__title for=__nav_5> <span class="md-nav__icon md-icon"></span> Compute Systems and Services </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_5_1 type=checkbox id=__nav_5_1> <div class="md-nav__link md-nav__link--index "> <a href=../../../../compute-systems/derecho/ >Derecho</a> <label for=__nav_5_1> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav aria-label=Derecho data-md-level=2> <label class=md-nav__title for=__nav_5_1> <span class="md-nav__icon md-icon"></span> Derecho </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../compute-systems/derecho/derecho-use-policies/ class=md-nav__link> Derecho Use Policies </a> </li> <li class=md-nav__item> <a href=../../../../compute-systems/derecho/compiling-code-on-derecho/ class=md-nav__link> Compiling Code on Derecho </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_5_1_4 type=checkbox id=__nav_5_1_4> <div class="md-nav__link md-nav__link--index "> <a href=../../../../compute-systems/derecho/starting-derecho-jobs/ >Starting Derecho Jobs</a> <label for=__nav_5_1_4> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav aria-label="Starting Derecho Jobs" data-md-level=3> <label class=md-nav__title for=__nav_5_1_4> <span class="md-nav__icon md-icon"></span> Starting Derecho Jobs </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_5_1_4_2 type=checkbox id=__nav_5_1_4_2> <label class=md-nav__link for=__nav_5_1_4_2> Derecho Job Script Examples <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Derecho Job Script Examples" data-md-level=4> <label class=md-nav__title for=__nav_5_1_4_2> <span class="md-nav__icon md-icon"></span> Derecho Job Script Examples </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../compute-systems/derecho/starting-derecho-jobs/derecho-job-script-examples/ class=md-nav__link> Derecho batch job script examples </a> </li> <li class=md-nav__item> <a href=../../../../compute-systems/derecho/starting-derecho-jobs/process-binding/ class=md-nav__link> Process Binding </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../../../compute-systems/derecho/derecho-modules/ class=md-nav__link> Derecho Software </a> </li> <li class=md-nav__item> <a href=../../../../compute-systems/derecho/moving-from-cheyenne/ class=md-nav__link> Moving to Derecho from Cheyenne </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_5_2 type=checkbox id=__nav_5_2> <div class="md-nav__link md-nav__link--index "> <a href=../../../../compute-systems/casper/ >Casper</a> <label for=__nav_5_2> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav aria-label=Casper data-md-level=2> <label class=md-nav__title for=__nav_5_2> <span class="md-nav__icon md-icon"></span> Casper </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../compute-systems/casper/casper-use-policies/ class=md-nav__link> Casper Use Policies </a> </li> <li class=md-nav__item> <a href=../../../../compute-systems/casper/compiling-code-on-casper/ class=md-nav__link> Compiling Code on Casper </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_5_2_4 type=checkbox id=__nav_5_2_4> <div class="md-nav__link md-nav__link--index "> <a href=../../../../compute-systems/casper/starting-casper-jobs/ >Starting Casper Jobs</a> <label for=__nav_5_2_4> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav aria-label="Starting Casper Jobs" data-md-level=3> <label class=md-nav__title for=__nav_5_2_4> <span class="md-nav__icon md-icon"></span> Starting Casper Jobs </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../compute-systems/casper/starting-casper-jobs/casper-job-script-examples/ class=md-nav__link> Casper job Script Examples </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../../../compute-systems/casper/remote-desktops/ class=md-nav__link> Using Remote Desktops </a> </li> <li class=md-nav__item> <a href=../../../../compute-systems/casper/casper-modules/ class=md-nav__link> Casper Software </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_5_3 type=checkbox id=__nav_5_3> <div class="md-nav__link md-nav__link--index "> <a href=../../../../compute-systems/jupyterhub/ >JupyterHub</a> <label for=__nav_5_3> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav aria-label=JupyterHub data-md-level=2> <label class=md-nav__title for=__nav_5_3> <span class="md-nav__icon md-icon"></span> JupyterHub </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../compute-systems/jupyter-and-ipython/ class=md-nav__link> Jupyter and IPython </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_5_4 type=checkbox id=__nav_5_4> <label class=md-nav__link for=__nav_5_4> Additional Resources <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Additional Resources" data-md-level=2> <label class=md-nav__title for=__nav_5_4> <span class="md-nav__icon md-icon"></span> Additional Resources </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../compute-systems/additional-resources/cron/ class=md-nav__link> Cron services </a> </li> <li class=md-nav__item> <a href=../../../../compute-systems/additional-resources/thunder-test-system/ class=md-nav__link> Thunder test system </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_6 type=checkbox id=__nav_6> <div class="md-nav__link md-nav__link--index "> <a href=../../../../pbs/ >Running Jobs (PBS)</a> <label for=__nav_6> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav aria-label="Running Jobs (PBS)" data-md-level=1> <label class=md-nav__title for=__nav_6> <span class="md-nav__icon md-icon"></span> Running Jobs (PBS) </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_6_2 type=checkbox id=__nav_6_2> <div class="md-nav__link md-nav__link--index "> <a href=../../../../pbs/job-scripts/ >Job Scripts</a> </div> <nav class=md-nav aria-label="Job Scripts" data-md-level=2> <label class=md-nav__title for=__nav_6_2> <span class="md-nav__icon md-icon"></span> Job Scripts </label> <ul class=md-nav__list data-md-scrollfix> </ul> </nav> </li> <li class=md-nav__item> <a href=../../../../pbs/charging/ class=md-nav__link> Queues and Charging </a> </li> <li class=md-nav__item> <a href=../../../../pbs/preemption/ class=md-nav__link> Using Preemption </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_6_5 type=checkbox id=__nav_6_5> <div class="md-nav__link md-nav__link--index "> <a href=../../../../pbs/common-causes-of-job-failures/ >Common Causes of Job Failures</a> <label for=__nav_6_5> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav aria-label="Common Causes of Job Failures" data-md-level=2> <label class=md-nav__title for=__nav_6_5> <span class="md-nav__icon md-icon"></span> Common Causes of Job Failures </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_6_5_2 type=checkbox id=__nav_6_5_2> <div class="md-nav__link md-nav__link--index "> <a href=../../../../pbs/checking-memory-use/ >Checking Memory Use</a> </div> <nav class=md-nav aria-label="Checking Memory Use" data-md-level=3> <label class=md-nav__title for=__nav_6_5_2> <span class="md-nav__icon md-icon"></span> Checking Memory Use </label> <ul class=md-nav__list data-md-scrollfix> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../../../pbs/storing-temporary-files/ class=md-nav__link> Storing temporary files </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_7 type=checkbox id=__nav_7> <div class="md-nav__link md-nav__link--index "> <a href=../../../../tutorials/ >Tutorials</a> <label for=__nav_7> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav aria-label=Tutorials data-md-level=1> <label class=md-nav__title for=__nav_7> <span class="md-nav__icon md-icon"></span> Tutorials </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../tutorials/new-user-training/ class=md-nav__link> New User Training </a> </li> <li class=md-nav__item> <a href=../../../../tutorials/dask-tutorial/ class=md-nav__link> Dask Tutorial </a> </li> <li class=md-nav__item> <a href=../../../../tutorials/profiling-and-debugging/ class=md-nav__link> Profiling and Debugging </a> </li> <li class=md-nav__item> <a href=../../../../tutorials/advanced-pbs/ class=md-nav__link> Advanced PBS </a> </li> <li class=md-nav__item> <a href=../../../../tutorials/jupyterhub/ class=md-nav__link> JupyterHub </a> </li> <li class=md-nav__item> <a href=../../../../tutorials/containers/ class=md-nav__link> Containers </a> </li> <li class=md-nav__item> <a href=../../../../tutorials/gpu-workshop/ class=md-nav__link> GPU Workshop </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_8 type=checkbox id=__nav_8> <div class="md-nav__link md-nav__link--index "> <a href=../../../../user-support/ >User Support</a> <label for=__nav_8> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav aria-label="User Support" data-md-level=1> <label class=md-nav__title for=__nav_8> <span class="md-nav__icon md-icon"></span> User Support </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_8_2 type=checkbox id=__nav_8_2> <label class=md-nav__link for=__nav_8_2> Troubleshooting Tips <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Troubleshooting Tips" data-md-level=2> <label class=md-nav__title for=__nav_8_2> <span class="md-nav__icon md-icon"></span> Troubleshooting Tips </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../user-support/troubleshooting-tips/killed-processes-on-login-nodes/ class=md-nav__link> Killed processes on login nodes </a> </li> <li class=md-nav__item> <a href=../../../../user-support/troubleshooting-tips/common-causes-of-job-failures/ class=md-nav__link> Common causes of job failures </a> </li> <li class=md-nav__item> <a href=../../../../user-support/troubleshooting-tips/batch-job-crashing/ class=md-nav__link> Batch jobs crashing </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_9 type=checkbox id=__nav_9> <div class="md-nav__link md-nav__link--index "> <a href=../../../../nhug/ >NCAR User Group (NHUG)</a> <label for=__nav_9> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav aria-label="NCAR User Group (NHUG)" data-md-level=1> <label class=md-nav__title for=__nav_9> <span class="md-nav__icon md-icon"></span> NCAR User Group (NHUG) </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_9_2 type=checkbox id=__nav_9_2> <div class="md-nav__link md-nav__link--index "> <a href=../../../../nhug/archive/ >Archive of Past Meetings</a> </div> <nav class=md-nav aria-label="Archive of Past Meetings" data-md-level=2> <label class=md-nav__title for=__nav_9_2> <span class="md-nav__icon md-icon"></span> Archive of Past Meetings </label> <ul class=md-nav__list data-md-scrollfix> </ul> </nav> </li> <li class=md-nav__item> <a href=../../../../nhug/upcoming-events/ class=md-nav__link> NHUG Upcoming Events </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../../../contributing/ class=md-nav__link> Contributing to the Documentation </a> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Page Outline"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Page Outline </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#nvidias-ngc-containers class=md-nav__link> NVIDIA's NGC containers </a> <nav class=md-nav aria-label="NVIDIA's NGC containers"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#nvidias-modulus-physics-ml-framework class=md-nav__link> NVIDIA's Modulus physics-ML framework </a> </li> <li class=md-nav__item> <a href=#popular-aiml-tools class=md-nav__link> Popular AI/ML tools </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#building-and-running-containerized-fasteddy-under-mpi-on-gpus class=md-nav__link> Building and running containerized FastEddy under MPI on GPUs </a> <nav class=md-nav aria-label="Building and running containerized FastEddy under MPI on GPUs"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#about-fasteddy class=md-nav__link> About FastEddy </a> </li> <li class=md-nav__item> <a href=#containerization-approach class=md-nav__link> Containerization approach </a> </li> <li class=md-nav__item> <a href=#building-the-image class=md-nav__link> Building the image </a> <nav class=md-nav aria-label="Building the image"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#the-base-layer class=md-nav__link> The base layer </a> </li> <li class=md-nav__item> <a href=#adding-cuda-cuda-aware-mpich class=md-nav__link> Adding CUDA &amp; CUDA-aware MPICH </a> </li> <li class=md-nav__item> <a href=#building-fasteddy class=md-nav__link> Building FastEddy </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#running-the-container-on-derecho class=md-nav__link> Running the container on Derecho </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <a href=https://github.com/NCAR/HPC-Docs/edit/main/docs/environment-and-software/user-environment/containers/examples.md title="Edit this page" class="md-content__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25Z"/></svg> </a> <h1 id=sample-containerized-workflows>Sample Containerized Workflows<a class=headerlink href=#sample-containerized-workflows title="Permanent link">&para;</a></h1> <div class="admonition warning"> <p class=admonition-title>Warning</p> <p>This page contains a sample of containerized workflows that demonstrate various techniques built up in practice, often from resolving user issues. We do not necessarily endorse or support each use case, rather these examples are provided in hopes they may be useful to demonstrate (i) sample containerized workflows, and (ii) solutions to various problems you may encounter.</p> </div> <h2 id=nvidias-ngc-containers>NVIDIA's NGC containers<a class=headerlink href=#nvidias-ngc-containers title="Permanent link">&para;</a></h2> <p>NVIDIA's <a href=https://catalog.ngc.nvidia.com>NGC</a> is a catalog of software optimized for GPUs. <a href=https://catalog.ngc.nvidia.com/containers>NGC containers</a> allow you to run data science projects "out of the box" without installing, configuring, or integrating the infrastructure.</p> <h3 id=nvidias-modulus-physics-ml-framework>NVIDIA's Modulus physics-ML framework<a class=headerlink href=#nvidias-modulus-physics-ml-framework title="Permanent link">&para;</a></h3> <p><a href=https://docs.nvidia.com/modulus/index.html>NVIDIA Modulus</a> is an open source deep-learning framework for building, training, and fine-tuning deep learning models using state-of-the-art Physics-ML methods. NVIDIA provides a frequently updated Docker image with a containerized PyTorch installation that can be run under Apptainer, albeit with some effort. Because the container is designed for Docker, some additional steps are required as discussed below.</p> <details class=example open=open> <summary>Running containerized NVIDIA-Modulus on a single Casper GPU</summary> <ol> <li> <p>Rather than pull the container and run as-is, we will create a derived container that allows us to encapsulate our desired changes. The primary reason for this is the Modulus container assumes the container is writable and makes changes during execution. Since we will run under Apptainer using a compressed, read-only image, this fails. Therefore we will make our own derived image and make the requisite changes during the build process.</p> <p>This is accomplished first by creating a simple Apptainer definition file: <div class=highlight><span class=filename>my_modulus.def</span><pre><span></span><code><span id=__span-0-1><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a>From: nvcr.io/nvidia/modulus/modulus:23.09
</span><span id=__span-0-2><a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a>
</span><span id=__span-0-3><a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a>%post
</span><span id=__span-0-4><a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a>    # update pip
</span><span id=__span-0-5><a id=__codelineno-0-5 name=__codelineno-0-5 href=#__codelineno-0-5></a>    python -m pip install --upgrade pip
</span><span id=__span-0-6><a id=__codelineno-0-6 name=__codelineno-0-6 href=#__codelineno-0-6></a>
</span><span id=__span-0-7><a id=__codelineno-0-7 name=__codelineno-0-7 href=#__codelineno-0-7></a>    # use pip to install additional packages needed for examples later
</span><span id=__span-0-8><a id=__codelineno-0-8 name=__codelineno-0-8 href=#__codelineno-0-8></a>    pip install warp-lang
</span><span id=__span-0-9><a id=__codelineno-0-9 name=__codelineno-0-9 href=#__codelineno-0-9></a>
</span><span id=__span-0-10><a id=__codelineno-0-10 name=__codelineno-0-10 href=#__codelineno-0-10></a>    # Remove cuda compat layer (https://github.com/NVIDIA/nvidia-docker/issues/1256)
</span><span id=__span-0-11><a id=__codelineno-0-11 name=__codelineno-0-11 href=#__codelineno-0-11></a>    # note that the source container attempts to do this at run-time, but that will
</span><span id=__span-0-12><a id=__codelineno-0-12 name=__codelineno-0-12 href=#__codelineno-0-12></a>    # fail when launched read-only.  So we do that here instead.
</span><span id=__span-0-13><a id=__codelineno-0-13 name=__codelineno-0-13 href=#__codelineno-0-13></a>    # (This issue will likely be resolved with newer versions of nvidia-modulus)
</span><span id=__span-0-14><a id=__codelineno-0-14 name=__codelineno-0-14 href=#__codelineno-0-14></a>    rm -rf /usr/local/cuda/compat/lib
</span></code></pre></div> The definition file begins by pulling a specified version of the Modulus container, then modifying it in our <code>%post</code> step. In <code>%post</code> we update the <code>pip</code> Python package installer, use <code>pip</code> to install some additional Python packages not in the base image but required for the examples run later, and finally removes a conflicting path from the source image.</p> <p>Using the <code>my_modulus.def</code> file we now create our derived container and store it as a SIF: <div class=highlight><pre><span></span><code><span id=__span-1-1><a id=__codelineno-1-1 name=__codelineno-1-1 href=#__codelineno-1-1></a>module load apptainer
</span><span id=__span-1-2><a id=__codelineno-1-2 name=__codelineno-1-2 href=#__codelineno-1-2></a>TMPDIR=/var/tmp/ singularity build my_modulus.sif my_modulus.def
</span></code></pre></div> Note in this step we have explicitly set <code>TMPDIR</code> to a local file system, as occasionally containers fail to build on the large parallel file systems usually used for <code>TMPDIR</code> within NCAR. (The failure symptoms are usually fatal error messages related to <code>xattrs</code>.)</p> </li> <li> <p>Fetch some examples so we can test our installation: <div class=highlight><pre><span></span><code><span id=__span-2-1><a id=__codelineno-2-1 name=__codelineno-2-1 href=#__codelineno-2-1></a>git clone https://github.com/NVIDIA/modulus.git
</span></code></pre></div></p> </li> <li> <p>Run the container in an interactive session on a single Casper GPU. We will launch an interactive session, then run the container interactively with the <code>singularity shell</code> command. <div class=highlight><pre><span></span><code><span id=__span-3-1><a id=__codelineno-3-1 name=__codelineno-3-1 href=#__codelineno-3-1></a># Interactive PBS submission from a login node:
</span><span id=__span-3-2><a id=__codelineno-3-2 name=__codelineno-3-2 href=#__codelineno-3-2></a>qsub -I -A &lt;ACCOUNT&gt; -q casper -l select=1:ncpus=4:mpiprocs=4:ngpus=1 -l gpu_type=v100 -l walltime=1:00:00
</span><span id=__span-3-3><a id=__codelineno-3-3 name=__codelineno-3-3 href=#__codelineno-3-3></a>
</span><span id=__span-3-4><a id=__codelineno-3-4 name=__codelineno-3-4 href=#__codelineno-3-4></a># Then on the GPU node:
</span><span id=__span-3-5><a id=__codelineno-3-5 name=__codelineno-3-5 href=#__codelineno-3-5></a>module load apptainer
</span><span id=__span-3-6><a id=__codelineno-3-6 name=__codelineno-3-6 href=#__codelineno-3-6></a>singularity shell \
</span><span id=__span-3-7><a id=__codelineno-3-7 name=__codelineno-3-7 href=#__codelineno-3-7></a>            --nv --cleanenv \
</span><span id=__span-3-8><a id=__codelineno-3-8 name=__codelineno-3-8 href=#__codelineno-3-8></a>            --bind /glade/work \
</span><span id=__span-3-9><a id=__codelineno-3-9 name=__codelineno-3-9 href=#__codelineno-3-9></a>            --bind /glade/campaign \
</span><span id=__span-3-10><a id=__codelineno-3-10 name=__codelineno-3-10 href=#__codelineno-3-10></a>            --bind /glade/derecho/scratch \
</span><span id=__span-3-11><a id=__codelineno-3-11 name=__codelineno-3-11 href=#__codelineno-3-11></a>            ./my_modulus.sif
</span></code></pre></div> Note the command line arguments to <code>singularity shell</code>:</p> <ul> <li><code>--nv</code>: enable Nvidia support,</li> <li><code>--cleanenv</code>: clean environment before running container, causing the container to be launched with no knowledge of environment variables set on the host. This is default behavior for Docker, and is required in this case to prevent conflicting <code>CUDA_*</code> and other environment variable settings from confusing the contanierized PyTorch.</li> <li><code>--bind /glade/work</code> etc...: binds host file systems into the container, allowing us to read and write from GLADE.</li> </ul> </li> <li> <p>Now we are inside the container, as evidenced by the <code>Apptainer&gt;</code> command line prompt in the final step of this example. We will run one of the sample problems checked out in step 3: <div class=highlight><pre><span></span><code><span id=__span-4-1><a id=__codelineno-4-1 name=__codelineno-4-1 href=#__codelineno-4-1></a>Apptainer&gt; cd modulus/examples/cfd/darcy_fno/
</span><span id=__span-4-2><a id=__codelineno-4-2 name=__codelineno-4-2 href=#__codelineno-4-2></a>Apptainer&gt; python ./train_fno_darcy.py
</span><span id=__span-4-3><a id=__codelineno-4-3 name=__codelineno-4-3 href=#__codelineno-4-3></a>Warp 0.10.1 initialized:
</span><span id=__span-4-4><a id=__codelineno-4-4 name=__codelineno-4-4 href=#__codelineno-4-4></a>   CUDA Toolkit: 11.5, Driver: 12.3
</span><span id=__span-4-5><a id=__codelineno-4-5 name=__codelineno-4-5 href=#__codelineno-4-5></a>   Devices:
</span><span id=__span-4-6><a id=__codelineno-4-6 name=__codelineno-4-6 href=#__codelineno-4-6></a>     &quot;cpu&quot;    | x86_64
</span><span id=__span-4-7><a id=__codelineno-4-7 name=__codelineno-4-7 href=#__codelineno-4-7></a>     &quot;cuda:0&quot; | Tesla V100-SXM2-32GB (sm_70)
</span><span id=__span-4-8><a id=__codelineno-4-8 name=__codelineno-4-8 href=#__codelineno-4-8></a>   Kernel cache: /glade/u/home/benkirk/.cache/warp/0.10.1
</span><span id=__span-4-9><a id=__codelineno-4-9 name=__codelineno-4-9 href=#__codelineno-4-9></a>[21:04:13 - mlflow - WARNING] Checking MLFlow logging location is working (if this hangs its not)
</span><span id=__span-4-10><a id=__codelineno-4-10 name=__codelineno-4-10 href=#__codelineno-4-10></a>[21:04:13 - mlflow - INFO] MLFlow logging location is working
</span><span id=__span-4-11><a id=__codelineno-4-11 name=__codelineno-4-11 href=#__codelineno-4-11></a>[21:04:13 - mlflow - INFO] No Darcy_FNO experiment found, creating...
</span><span id=__span-4-12><a id=__codelineno-4-12 name=__codelineno-4-12 href=#__codelineno-4-12></a>[21:04:13 - checkpoint - WARNING] Provided checkpoint directory ./checkpoints does not exist, skipping load
</span><span id=__span-4-13><a id=__codelineno-4-13 name=__codelineno-4-13 href=#__codelineno-4-13></a>[21:04:13 - darcy_fno - WARNING] Model FourierNeuralOperator does not support AMP on GPUs, turning off
</span><span id=__span-4-14><a id=__codelineno-4-14 name=__codelineno-4-14 href=#__codelineno-4-14></a>[21:04:13 - darcy_fno - WARNING] Model FourierNeuralOperator does not support AMP on GPUs, turning off
</span><span id=__span-4-15><a id=__codelineno-4-15 name=__codelineno-4-15 href=#__codelineno-4-15></a>[21:04:13 - darcy_fno - INFO] Training started...
</span><span id=__span-4-16><a id=__codelineno-4-16 name=__codelineno-4-16 href=#__codelineno-4-16></a>Module modulus.datapipes.benchmarks.kernels.initialization load on device &#39;cuda:0&#39; took 205.84 ms
</span><span id=__span-4-17><a id=__codelineno-4-17 name=__codelineno-4-17 href=#__codelineno-4-17></a>Module modulus.datapipes.benchmarks.kernels.utils load on device &#39;cuda:0&#39; took 212.94 ms
</span><span id=__span-4-18><a id=__codelineno-4-18 name=__codelineno-4-18 href=#__codelineno-4-18></a>Module modulus.datapipes.benchmarks.kernels.finite_difference load on device &#39;cuda:0&#39; took 670.44 ms
</span><span id=__span-4-19><a id=__codelineno-4-19 name=__codelineno-4-19 href=#__codelineno-4-19></a>[21:04:46 - train - INFO] Epoch 1 Metrics: Learning Rate =  1.000e-03, loss =  6.553e-01
</span><span id=__span-4-20><a id=__codelineno-4-20 name=__codelineno-4-20 href=#__codelineno-4-20></a>[21:04:46 - train - INFO] Epoch Execution Time:  3.241e+01s, Time/Iter:  1.013e+03ms
</span><span id=__span-4-21><a id=__codelineno-4-21 name=__codelineno-4-21 href=#__codelineno-4-21></a>[21:05:14 - train - INFO] Epoch 2 Metrics: Learning Rate =  1.000e-03, loss =  4.255e-02
</span><span id=__span-4-22><a id=__codelineno-4-22 name=__codelineno-4-22 href=#__codelineno-4-22></a>[21:05:14 - train - INFO] Epoch Execution Time:  2.812e+01s, Time/Iter:  8.786e+02ms
</span><span id=__span-4-23><a id=__codelineno-4-23 name=__codelineno-4-23 href=#__codelineno-4-23></a>[...]
</span></code></pre></div></p> </li> </ol> <hr> <p>While this example demonstrated running the container interactively, alternatively steps 3 and 4 can be combined to be run inside a PBS batch job.</p> </details> <h3 id=popular-aiml-tools>Popular AI/ML tools<a class=headerlink href=#popular-aiml-tools title="Permanent link">&para;</a></h3> <p>Optimized Tensorflow and PyTorch models are available directly from the NGC.</p> <details class=example open=open> <summary>Running AI/ML tools from NGC containers</summary> <p><strong>Building an image with Apptainer</strong></p> <p>Anticipating that we may want to make additions to the container, we will build our own derived Apptainer image using a Definition file.</p> <div class="tabbed-set tabbed-alternate" data-tabs=1:2><input checked=checked id=__tabbed_1_1 name=__tabbed_1 type=radio><input id=__tabbed_1_2 name=__tabbed_1 type=radio><div class=tabbed-labels><label for=__tabbed_1_1>Tensorflow</label><label for=__tabbed_1_2>PyTorch</label></div> <div class=tabbed-content> <div class=tabbed-block> <p><div class=highlight><span class=filename>ngc_tensorflow.def</span><pre><span></span><code><span id=__span-5-1><a id=__codelineno-5-1 name=__codelineno-5-1 href=#__codelineno-5-1></a>Bootstrap: docker
</span><span id=__span-5-2><a id=__codelineno-5-2 name=__codelineno-5-2 href=#__codelineno-5-2></a>From: nvcr.io/nvidia/tensorflow:23.11-tf2-py3
</span><span id=__span-5-3><a id=__codelineno-5-3 name=__codelineno-5-3 href=#__codelineno-5-3></a>
</span><span id=__span-5-4><a id=__codelineno-5-4 name=__codelineno-5-4 href=#__codelineno-5-4></a>%post
</span><span id=__span-5-5><a id=__codelineno-5-5 name=__codelineno-5-5 href=#__codelineno-5-5></a>    # update pip
</span><span id=__span-5-6><a id=__codelineno-5-6 name=__codelineno-5-6 href=#__codelineno-5-6></a>    python -m pip install --upgrade pip
</span><span id=__span-5-7><a id=__codelineno-5-7 name=__codelineno-5-7 href=#__codelineno-5-7></a>
</span><span id=__span-5-8><a id=__codelineno-5-8 name=__codelineno-5-8 href=#__codelineno-5-8></a>[...]
</span></code></pre></div> <div class=highlight><pre><span></span><code><span id=__span-6-1><a id=__codelineno-6-1 name=__codelineno-6-1 href=#__codelineno-6-1></a>module<span class=w> </span>load<span class=w> </span>apptainer
</span><span id=__span-6-2><a id=__codelineno-6-2 name=__codelineno-6-2 href=#__codelineno-6-2></a><span class=nv>TMPDIR</span><span class=o>=</span>/var/tmp/<span class=w> </span>singularity<span class=w> </span>build<span class=w> </span>my_image.sif<span class=w> </span>ngc_tensorflow.def
</span></code></pre></div></p> </div> <div class=tabbed-block> <p><div class=highlight><span class=filename>ngc_pytorch.def</span><pre><span></span><code><span id=__span-7-1><a id=__codelineno-7-1 name=__codelineno-7-1 href=#__codelineno-7-1></a>Bootstrap: docker
</span><span id=__span-7-2><a id=__codelineno-7-2 name=__codelineno-7-2 href=#__codelineno-7-2></a>From: nvcr.io/nvidia/pytorch:23.11-py3
</span><span id=__span-7-3><a id=__codelineno-7-3 name=__codelineno-7-3 href=#__codelineno-7-3></a>
</span><span id=__span-7-4><a id=__codelineno-7-4 name=__codelineno-7-4 href=#__codelineno-7-4></a>%post
</span><span id=__span-7-5><a id=__codelineno-7-5 name=__codelineno-7-5 href=#__codelineno-7-5></a>    # update pip
</span><span id=__span-7-6><a id=__codelineno-7-6 name=__codelineno-7-6 href=#__codelineno-7-6></a>    python -m pip install --upgrade pip
</span><span id=__span-7-7><a id=__codelineno-7-7 name=__codelineno-7-7 href=#__codelineno-7-7></a>
</span><span id=__span-7-8><a id=__codelineno-7-8 name=__codelineno-7-8 href=#__codelineno-7-8></a>[...]
</span></code></pre></div> <div class=highlight><pre><span></span><code><span id=__span-8-1><a id=__codelineno-8-1 name=__codelineno-8-1 href=#__codelineno-8-1></a>module<span class=w> </span>load<span class=w> </span>apptainer
</span><span id=__span-8-2><a id=__codelineno-8-2 name=__codelineno-8-2 href=#__codelineno-8-2></a><span class=nv>TMPDIR</span><span class=o>=</span>/var/tmp/<span class=w> </span>singularity<span class=w> </span>build<span class=w> </span>my_image.sif<span class=w> </span>ngc_pytorch.def
</span></code></pre></div></p> </div> </div> </div> <p><strong>Run the image</strong></p> <p><div class=highlight><pre><span></span><code><span id=__span-9-1><a id=__codelineno-9-1 name=__codelineno-9-1 href=#__codelineno-9-1></a>module load apptainer
</span><span id=__span-9-2><a id=__codelineno-9-2 name=__codelineno-9-2 href=#__codelineno-9-2></a>singularity shell \
</span><span id=__span-9-3><a id=__codelineno-9-3 name=__codelineno-9-3 href=#__codelineno-9-3></a>            --nv --cleanenv \
</span><span id=__span-9-4><a id=__codelineno-9-4 name=__codelineno-9-4 href=#__codelineno-9-4></a>            --bind /glade/work \
</span><span id=__span-9-5><a id=__codelineno-9-5 name=__codelineno-9-5 href=#__codelineno-9-5></a>            --bind /glade/campaign \
</span><span id=__span-9-6><a id=__codelineno-9-6 name=__codelineno-9-6 href=#__codelineno-9-6></a>            --bind /glade/derecho/scratch \
</span><span id=__span-9-7><a id=__codelineno-9-7 name=__codelineno-9-7 href=#__codelineno-9-7></a>            ./my_image.sif
</span><span id=__span-9-8><a id=__codelineno-9-8 name=__codelineno-9-8 href=#__codelineno-9-8></a>[...]
</span><span id=__span-9-9><a id=__codelineno-9-9 name=__codelineno-9-9 href=#__codelineno-9-9></a>Apptainer&gt;
</span></code></pre></div> We are now inside the container. Note the command line arguments to <code>singularity shell</code>: <code>--nv --cleanenv</code> enables NVIDIA support with a clean environment; <code>--bind /glade/work</code> etc...: binds host file systems into the container, allowing us to read and write from GLADE.</p> </details> <hr> <h2 id=building-and-running-containerized-fasteddy-under-mpi-on-gpus>Building and running containerized FastEddy under MPI on GPUs<a class=headerlink href=#building-and-running-containerized-fasteddy-under-mpi-on-gpus title="Permanent link">&para;</a></h2> <div class="admonition warning inline end"> <p class=admonition-title>Warning</p> <p>While the result of this demonstration is a functional application, we recommend against using this container for production FastEddy workflows!</p> <p><strong>It is much easier to simply build FasyEddy "bare metal" when operating inside the NCAR HPC environment!!</strong></p> </div> <p>This example demonstrates building a containerized version of <a href=https://ral.ucar.edu/fasteddy>FastEddy</a> from the <a href=https://github.com/NCAR/FastEddy-model>open-source variant hosted on GitHub</a>. It is <strong><em>provided for demonstration purposes</em></strong> because it demonstrates several common issues encountered when running GPU-aware MPI applications inside containers across multiple nodes, particularly when binding the host MPI into the container, and the source code is open for any interested user to follow along and adapt.</p> <h3 id=about-fasteddy>About FastEddy<a class=headerlink href=#about-fasteddy title="Permanent link">&para;</a></h3> <p>FastEddy is a large-eddy simulation (LES) model developed by the Research Applications Laboratory (RAL) here at NCAR. The fundamental premise of FastEddy model development is to leverage the accelerated and more power efficient computing capacity of graphics processing units (GPU)s to enable not only more widespread use of LES in research activities but also to pursue the adoption of microscale and multiscale, turbulence-resolving, atmospheric boundary layer modeling into local scale weather prediction or actionable science and engineering applications.</p> <h3 id=containerization-approach>Containerization approach<a class=headerlink href=#containerization-approach title="Permanent link">&para;</a></h3> <p>The container is built <strong>off-premises</strong> with <code>docker</code> from three related images, each providing a foundation for the next. We begin with a</p> <ol> <li>Rockylinux version 8 operating system with OpenHPC version 2 installed, then add</li> <li>a CUDA development environment and a CUDA-aware MPICH installation on top, and finally add</li> <li>the FastEddy source and compiled program.</li> </ol> <p>A benefit of this layered approach is that the intermediate images created in steps 1 and 2 can be beneficial in their own right, providing base layers for other projects with similar needs. Additionally, by building the image externally with Docker we are able to switch user IDs within the process (discussed further below), which has some benefits when using containers to enable <em>development</em> workflows.</p> <h3 id=building-the-image>Building the image<a class=headerlink href=#building-the-image title="Permanent link">&para;</a></h3> <div class="admonition info inline end"> <p class=admonition-title>Build framework</p> <p>For complete details of the build process, see the Docker-based container build framework described <a href=https://github.com/benkirk/containers>here</a>.</p> </div> <p>The image was built external to the HPC environment and then pushed to Docker Hub. (For users only interested in the details of <em>running</em> such a container, see <a href=#running-the-container-on-derecho>instructions for running the container</a> below.)</p> <p>In this case a simple Mac laptop with <code>git</code>, GNU <code>make</code>, and <code>docker</code> all installed locally was used and the process takes about an hour; any similarly configured system should suffice. No GPU devices are required to build the image.</p> <h4 id=the-base-layer>The base layer<a class=headerlink href=#the-base-layer title="Permanent link">&para;</a></h4> <details class=example open=open> <summary>The Rockylinx 8 + OpenHPC base layer</summary> <p>For the base layer we deploy an <a href=https://openhpc.community/openhpc-2-0-released>OpenHPC v2</a> installation on top of a Rocklinux v8 base image. OpenHPC provides access to many pre-complied scientific libraries and applications, and supports a matrix of compilers and MPI permutations. and we will select one that works well with Derecho. Notably, at present OpenHPC does <strong>not</strong> natively support CUDA installations, however we will address this limitation in the subsequent steps.</p> <p><div class=highlight><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>rocky8/OpenHPC-mpich/Dockerfile</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-10-1> 1</a></span>
<span class=normal><a href=#__codelineno-10-2> 2</a></span>
<span class=normal><a href=#__codelineno-10-3> 3</a></span>
<span class=normal><a href=#__codelineno-10-4> 4</a></span>
<span class=normal><a href=#__codelineno-10-5> 5</a></span>
<span class=normal><a href=#__codelineno-10-6> 6</a></span>
<span class=normal><a href=#__codelineno-10-7> 7</a></span>
<span class=normal><a href=#__codelineno-10-8> 8</a></span>
<span class=normal><a href=#__codelineno-10-9> 9</a></span>
<span class=normal><a href=#__codelineno-10-10>10</a></span>
<span class=normal><a href=#__codelineno-10-11>11</a></span>
<span class=normal><a href=#__codelineno-10-12>12</a></span>
<span class=normal><a href=#__codelineno-10-13>13</a></span>
<span class=normal><a href=#__codelineno-10-14>14</a></span>
<span class=normal><a href=#__codelineno-10-15>15</a></span>
<span class=normal><a href=#__codelineno-10-16>16</a></span>
<span class=normal><a href=#__codelineno-10-17>17</a></span>
<span class=normal><a href=#__codelineno-10-18>18</a></span>
<span class=normal><a href=#__codelineno-10-19>19</a></span>
<span class=normal><a href=#__codelineno-10-20>20</a></span>
<span class=normal><a href=#__codelineno-10-21>21</a></span>
<span class=normal><a href=#__codelineno-10-22>22</a></span>
<span class=normal><a href=#__codelineno-10-23>23</a></span>
<span class=normal><a href=#__codelineno-10-24>24</a></span>
<span class=normal><a href=#__codelineno-10-25>25</a></span>
<span class=normal><a href=#__codelineno-10-26>26</a></span>
<span class=normal><a href=#__codelineno-10-27>27</a></span>
<span class=normal><a href=#__codelineno-10-28>28</a></span>
<span class=normal><a href=#__codelineno-10-29>29</a></span>
<span class=normal><a href=#__codelineno-10-30>30</a></span>
<span class=normal><a href=#__codelineno-10-31>31</a></span>
<span class=normal><a href=#__codelineno-10-32>32</a></span>
<span class=normal><a href=#__codelineno-10-33>33</a></span>
<span class=normal><a href=#__codelineno-10-34>34</a></span>
<span class=normal><a href=#__codelineno-10-35>35</a></span>
<span class=normal><a href=#__codelineno-10-36>36</a></span>
<span class=normal><a href=#__codelineno-10-37>37</a></span>
<span class=normal><a href=#__codelineno-10-38>38</a></span>
<span class=normal><a href=#__codelineno-10-39>39</a></span>
<span class=normal><a href=#__codelineno-10-40>40</a></span>
<span class=normal><a href=#__codelineno-10-41>41</a></span>
<span class=normal><a href=#__codelineno-10-42>42</a></span>
<span class=normal><a href=#__codelineno-10-43>43</a></span>
<span class=normal><a href=#__codelineno-10-44>44</a></span>
<span class=normal><a href=#__codelineno-10-45>45</a></span>
<span class=normal><a href=#__codelineno-10-46>46</a></span>
<span class=normal><a href=#__codelineno-10-47>47</a></span>
<span class=normal><a href=#__codelineno-10-48>48</a></span>
<span class=normal><a href=#__codelineno-10-49>49</a></span>
<span class=normal><a href=#__codelineno-10-50>50</a></span>
<span class=normal><a href=#__codelineno-10-51>51</a></span>
<span class=normal><a href=#__codelineno-10-52>52</a></span>
<span class=normal><a href=#__codelineno-10-53>53</a></span>
<span class=normal><a href=#__codelineno-10-54>54</a></span>
<span class=normal><a href=#__codelineno-10-55>55</a></span>
<span class=normal><a href=#__codelineno-10-56>56</a></span>
<span class=normal><a href=#__codelineno-10-57>57</a></span>
<span class=normal><a href=#__codelineno-10-58>58</a></span>
<span class=normal><a href=#__codelineno-10-59>59</a></span>
<span class=normal><a href=#__codelineno-10-60>60</a></span>
<span class=normal><a href=#__codelineno-10-61>61</a></span>
<span class=normal><a href=#__codelineno-10-62>62</a></span>
<span class=normal><a href=#__codelineno-10-63>63</a></span>
<span class=normal><a href=#__codelineno-10-64>64</a></span>
<span class=normal><a href=#__codelineno-10-65>65</a></span>
<span class=normal><a href=#__codelineno-10-66>66</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-10-1><a id=__codelineno-10-1 name=__codelineno-10-1></a>FROM docker.io/rockylinux/rockylinux:8
</span><span id=__span-10-2><a id=__codelineno-10-2 name=__codelineno-10-2></a>
</span><span id=__span-10-3><a id=__codelineno-10-3 name=__codelineno-10-3></a>ADD extras/docker-clean /usr/bin/docker-clean
</span><span id=__span-10-4><a id=__codelineno-10-4 name=__codelineno-10-4></a>
</span><span id=__span-10-5><a id=__codelineno-10-5 name=__codelineno-10-5></a>ARG COMPILER_VERSION=gnu9
</span><span id=__span-10-6><a id=__codelineno-10-6 name=__codelineno-10-6></a>ARG MPI_FAMILY=mpich
</span><span id=__span-10-7><a id=__codelineno-10-7 name=__codelineno-10-7></a>ARG MPI_FAMILY_VARIANT=mpich-ofi
</span><span id=__span-10-8><a id=__codelineno-10-8 name=__codelineno-10-8></a>ARG MPICH_VERSION=3.4.3
</span><span id=__span-10-9><a id=__codelineno-10-9 name=__codelineno-10-9></a>ARG OSU_VERSION=7.2
</span><span id=__span-10-10><a id=__codelineno-10-10 name=__codelineno-10-10></a>
</span><span id=__span-10-11><a id=__codelineno-10-11 name=__codelineno-10-11></a># Basic OpenHPC development environment setup, derived from Install_guide-Rocky8-Warewulf-SLURM-2.4
</span><span id=__span-10-12><a id=__codelineno-10-12 name=__codelineno-10-12></a>RUN echo &quot;yum/dnf config&quot; \
</span><span id=__span-10-13><a id=__codelineno-10-13 name=__codelineno-10-13></a>    &amp;&amp; set -x \
</span><span id=__span-10-14><a id=__codelineno-10-14 name=__codelineno-10-14></a>    &amp;&amp; adduser plainuser \
</span><span id=__span-10-15><a id=__codelineno-10-15 name=__codelineno-10-15></a>    &amp;&amp; chmod a+rx /usr/bin/docker-clean &amp;&amp; docker-clean \
</span><span id=__span-10-16><a id=__codelineno-10-16 name=__codelineno-10-16></a>    &amp;&amp; yum -y update \
</span><span id=__span-10-17><a id=__codelineno-10-17 name=__codelineno-10-17></a>    &amp;&amp; yum -y install which git tar curl xz bzip2 patch \
</span><span id=__span-10-18><a id=__codelineno-10-18 name=__codelineno-10-18></a>    &amp;&amp; yum -y install http://repos.openhpc.community/OpenHPC/2/EL_8/x86_64/ohpc-release-2-1.el8.x86_64.rpm \
</span><span id=__span-10-19><a id=__codelineno-10-19 name=__codelineno-10-19></a>    &amp;&amp; yum -y install dnf-plugins-core \
</span><span id=__span-10-20><a id=__codelineno-10-20 name=__codelineno-10-20></a>    &amp;&amp; yum config-manager --set-enabled powertools \
</span><span id=__span-10-21><a id=__codelineno-10-21 name=__codelineno-10-21></a>    &amp;&amp; yum -y install ohpc-base \
</span><span id=__span-10-22><a id=__codelineno-10-22 name=__codelineno-10-22></a>    &amp;&amp; yum -y install lmod-ohpc nhc-ohpc ohpc-autotools \
</span><span id=__span-10-23><a id=__codelineno-10-23 name=__codelineno-10-23></a>    &amp;&amp; yum -y install ${COMPILER_VERSION}-compilers-ohpc \
</span><span id=__span-10-24><a id=__codelineno-10-24 name=__codelineno-10-24></a>    &amp;&amp; yum -y install hwloc-ohpc valgrind-ohpc \
</span><span id=__span-10-25><a id=__codelineno-10-25 name=__codelineno-10-25></a>    &amp;&amp; yum -y install ${MPI_FAMILY_VARIANT}-${COMPILER_VERSION}-ohpc \
</span><span id=__span-10-26><a id=__codelineno-10-26 name=__codelineno-10-26></a>    &amp;&amp; yum -y install lmod-defaults-${COMPILER_VERSION}-${MPI_FAMILY_VARIANT}-ohpc \
</span><span id=__span-10-27><a id=__codelineno-10-27 name=__codelineno-10-27></a>    &amp;&amp; docker-clean
</span><span id=__span-10-28><a id=__codelineno-10-28 name=__codelineno-10-28></a>
</span><span id=__span-10-29><a id=__codelineno-10-29 name=__codelineno-10-29></a># Prevent mpicxx from linking -lmpicxx, which we do not need, and cannot use on our Cray-EX
</span><span id=__span-10-30><a id=__codelineno-10-30 name=__codelineno-10-30></a>RUN sed -i &#39;s/cxxlibs=&quot;-lmpicxx&quot;/cxxlibs= #&quot;-lmpicxx&quot;/g&#39; /opt/ohpc/pub/mpi/${MPI_FAMILY_VARIANT}-${COMPILER_VERSION}-ohpc/3.4.2/bin/mpicxx
</span><span id=__span-10-31><a id=__codelineno-10-31 name=__codelineno-10-31></a>
</span><span id=__span-10-32><a id=__codelineno-10-32 name=__codelineno-10-32></a>RUN mkdir -p /opt/local \
</span><span id=__span-10-33><a id=__codelineno-10-33 name=__codelineno-10-33></a>    &amp;&amp; chown -R plainuser: /home/plainuser/ /opt/local
</span><span id=__span-10-34><a id=__codelineno-10-34 name=__codelineno-10-34></a>
</span><span id=__span-10-35><a id=__codelineno-10-35 name=__codelineno-10-35></a>COPY extras/hello_world_mpi.C /home/plainuser/
</span><span id=__span-10-36><a id=__codelineno-10-36 name=__codelineno-10-36></a>
</span><span id=__span-10-37><a id=__codelineno-10-37 name=__codelineno-10-37></a>USER plainuser
</span><span id=__span-10-38><a id=__codelineno-10-38 name=__codelineno-10-38></a>SHELL [&quot;/bin/bash&quot;, &quot;-lc&quot;]
</span><span id=__span-10-39><a id=__codelineno-10-39 name=__codelineno-10-39></a>
</span><span id=__span-10-40><a id=__codelineno-10-40 name=__codelineno-10-40></a>RUN echo &quot;Installing MPI benchmark applications&quot; \
</span><span id=__span-10-41><a id=__codelineno-10-41 name=__codelineno-10-41></a>    &amp;&amp; whoami &amp;&amp; module avail &amp;&amp; module list \
</span><span id=__span-10-42><a id=__codelineno-10-42 name=__codelineno-10-42></a>    &amp;&amp; echo &quot;OSU:&quot; \
</span><span id=__span-10-43><a id=__codelineno-10-43 name=__codelineno-10-43></a>    &amp;&amp; cd /tmp &amp;&amp; curl -Sl https://mvapich.cse.ohio-state.edu/download/mvapich/osu-micro-benchmarks-${OSU_VERSION}.tar.gz | tar xz \
</span><span id=__span-10-44><a id=__codelineno-10-44 name=__codelineno-10-44></a>    &amp;&amp; cd osu-micro-benchmarks-${OSU_VERSION} \
</span><span id=__span-10-45><a id=__codelineno-10-45 name=__codelineno-10-45></a>    &amp;&amp; ./configure --help \
</span><span id=__span-10-46><a id=__codelineno-10-46 name=__codelineno-10-46></a>    &amp;&amp; ./configure --prefix=/opt/local/osu-micro-benchmarks-${OSU_VERSION} \
</span><span id=__span-10-47><a id=__codelineno-10-47 name=__codelineno-10-47></a>                   CXX=$(which mpicxx) CC=$(which mpicc) FC=$(which mpif90) F77=$(which mpif77) \
</span><span id=__span-10-48><a id=__codelineno-10-48 name=__codelineno-10-48></a>    &amp;&amp; make -j 8 V=0 &amp;&amp; rm -rf /opt/local/osu-micro-benchmarks-${OSU_VERSION} &amp;&amp; make install \
</span><span id=__span-10-49><a id=__codelineno-10-49 name=__codelineno-10-49></a>    &amp;&amp; cd &amp;&amp; rm -rf /tmp/osu-micro-benchmarks-${OSU_VERSION} \
</span><span id=__span-10-50><a id=__codelineno-10-50 name=__codelineno-10-50></a>    &amp;&amp; cd /opt/local &amp;&amp; mpicxx -o hello_world_mpi /home/plainuser/hello_world_mpi.C -fopenmp \
</span><span id=__span-10-51><a id=__codelineno-10-51 name=__codelineno-10-51></a>    &amp;&amp; echo &quot;IMB:&quot; \
</span><span id=__span-10-52><a id=__codelineno-10-52 name=__codelineno-10-52></a>    &amp;&amp; cd /opt/local &amp;&amp; rm -rf imb-2021.3 &amp;&amp; git clone https://github.com/intel/mpi-benchmarks.git imb-2021.3 \
</span><span id=__span-10-53><a id=__codelineno-10-53 name=__codelineno-10-53></a>    &amp;&amp; cd /opt/local/imb-2021.3 &amp;&amp; git checkout 8ba5d968272b6e7b384f91b6597d1c4590faf3db \
</span><span id=__span-10-54><a id=__codelineno-10-54 name=__codelineno-10-54></a>    &amp;&amp; CXX=$(which mpicxx) CC=$(which mpicc) make \
</span><span id=__span-10-55><a id=__codelineno-10-55 name=__codelineno-10-55></a>    &amp;&amp; make -C src_cpp -f Makefile TARGET=MPI1 clean \
</span><span id=__span-10-56><a id=__codelineno-10-56 name=__codelineno-10-56></a>    &amp;&amp; make -C src_cpp -f Makefile TARGET=NBC clean\
</span><span id=__span-10-57><a id=__codelineno-10-57 name=__codelineno-10-57></a>    &amp;&amp; make -C src_cpp -f Makefile TARGET=RMA clean \
</span><span id=__span-10-58><a id=__codelineno-10-58 name=__codelineno-10-58></a>    &amp;&amp; make -C src_cpp -f Makefile TARGET=EXT clean \
</span><span id=__span-10-59><a id=__codelineno-10-59 name=__codelineno-10-59></a>    &amp;&amp; make -C src_cpp -f Makefile TARGET=IO clean \
</span><span id=__span-10-60><a id=__codelineno-10-60 name=__codelineno-10-60></a>    &amp;&amp; make -C src_cpp -f Makefile TARGET=MT clean \
</span><span id=__span-10-61><a id=__codelineno-10-61 name=__codelineno-10-61></a>    &amp;&amp; make -C src_c/P2P -f Makefile TARGET=P2P clean \
</span><span id=__span-10-62><a id=__codelineno-10-62 name=__codelineno-10-62></a>    &amp;&amp; docker-clean
</span><span id=__span-10-63><a id=__codelineno-10-63 name=__codelineno-10-63></a>
</span><span id=__span-10-64><a id=__codelineno-10-64 name=__codelineno-10-64></a># Local Variables:
</span><span id=__span-10-65><a id=__codelineno-10-65 name=__codelineno-10-65></a># mode: sh
</span><span id=__span-10-66><a id=__codelineno-10-66 name=__codelineno-10-66></a># End:
</span></code></pre></div></td></tr></table></div> <strong>Dockerfile Steps</strong></p> <ol> <li>The image begins with a minimal Rockylinux v8 image, and adds a utility script <code>docker-clean</code> copied from the build host.</li> <li>We parameterize several variables with build arguments using the <code>ARG</code> instructions. (Build arguments are available within the image build process as environment variables, but <em>not</em> when running the resulting container image; rather <code>ENV</code> instructions can be used for those purposes. For a full discussion of <code>Dockerfiles</code> and supported instructions see <a href=https://docs.docker.com/engine/reference/builder/ >here</a>.)</li> <li> <p>We then perform a number of <code>RUN</code> steps. When running <code>docker</code>, each <code>RUN</code> step creates a subsequent <em>layer</em> in the image. (We follow general Docker <a href=https://docs.docker.com/develop/develop-images/instructions/ >guidance</a> and also strive to <a href=https://stackoverflow.com/questions/39223249/multiple-run-vs-single-chained-run-in-dockerfile-which-is-better>combine related commands</a> inside a handful of <code>RUN</code> instructions.)</p> <ol> <li>The first <code>RUN</code> instruction takes us from the very basic Rockylinux 8 source image to a full OpenHPC installation. We add a non-privileged user <code>plainuser</code> to leverage later, update the OS image with any available security patches, and then generally follow an <a href=https://github.com/openhpc/ohpc/releases/download/v2.7.GA/Install_guide-Rocky8-Warewulf-SLURM-2.7-aarch64.pdf>OpenHPC installation recipe</a> to add compilers, MPI, and other useful development tools.</li> <li>The second <code>RUN</code> step works around an issue we would find later when attempting to run the image on Derecho. Specifically, the OpenHPC <code>mpich-ofi</code> package provides support for the long-deprecated MPI C++ interface. This is not present on Derecho with the <code>cray-mpich</code> implementation we will ultimately use to run the container. Since we do not need this support, here we hack the <code>mpicxx</code> wrapper so that it does not link in <code>-lmpicxx</code>, the problematic library.</li> <li>The third and following <code>RUN</code> instructions steps create a directory space <code>/opt/local</code> we can use from our unprivileged <code>plainuser</code> account, copy in some more files, and then switch to <code>plainuser</code> to test the development environment by installing some common MPI benchmarks.</li> </ol> </li> </ol> <p><strong>Discussion</strong></p> <ul> <li> <p>OpenHPC v2 supports both OpenSUSE and Rocklinux 8 as its base OS. It would be natural to choose OpenSUSE for similarity to Casper and Derecho, however by choosing instead Rocklinux we gain access to a different build environment, which has benefits for developers looking to improve portability. This process followed here can also be thought of as a "roadmap" for deploying the application at similarly configured external sites.</p> </li> <li> <p>OpenHPC supports <code>openmpi</code> and <code>mpich</code> MPI implementations, with the latter in two forms: <code>mpich-ucx</code> and <code>mpich-ofi</code>. In this example we intentionally choose <code>mpich-ofi</code> with prior knowledge of the target execution environment. On Derecho the primary MPI implementation is <code>cray-mpich</code> (itself forked from <code>mpich</code>) which uses an HPE-proprietary <code>libfabric</code> interface to the Slingshot v11 high-speed communication fabric.</p> </li> <li> <p>Notice that each <code>RUN</code> step is finalized with a <a href=https://github.com/benkirk/containers/blob/main/extras/docker-clean><code>docker-clean</code> command</a>. This utility script removes temporary files and cached data to minimize the size of the resulting image layers. One consequence is that the first <code>dnf</code> package manager interaction in a <code>RUN</code> statement will re-cache these data. Since cached data are not relevant in the final image - especially when run much later on - we recommend removing it to reduce image bloat.</p> </li> <li> <p>In this example we are intentional switching between <code>root</code> (the default user in the build process) and our unprivileged <code>plainuser</code> account. Particularly in development workflows, we want to be sure compilation and installation steps work properly as an unprivileged user, and tools such as the <code>lmod</code> module system and <code>mpiexec</code> often are intended <em>not</em> to be used as <code>root</code>.</p> </li> <li> <p>Since MPI container runtime inregration can be a pain point at execution, we install <a href=https://mvapich.cse.ohio-state.edu/benchmarks/ >OSU's</a> and <a href=https://www.intel.com/content/www/us/en/developer/articles/technical/intel-mpi-benchmarks.html>Intel's</a> MPI benchmark suites to aid in deployment testing, independent of any user application.</p> </li> </ul> <hr> <p><strong>Building the image</strong> <div class=highlight><pre><span></span><code><span id=__span-11-1><a id=__codelineno-11-1 name=__codelineno-11-1 href=#__codelineno-11-1></a><span class=go>docker build --tag &lt;dockerhub_username&gt;/rocky8-openhpc-mpich:latest .</span>
</span></code></pre></div></p> </details> <h4 id=adding-cuda-cuda-aware-mpich>Adding CUDA &amp; CUDA-aware MPICH<a class=headerlink href=#adding-cuda-cuda-aware-mpich title="Permanent link">&para;</a></h4> <details class=example open=open> <summary>Adding CUDA + CUDA-aware MPICH</summary> <p>Next we add CUDA and add a CUDA-aware MPI installation. We choose a specific version of the open-source MPICH library (both to closely match what is provided by OpenHPC and for Derecho compatibility) and configure it to use the pre-existing OpenHPC artifacts (<code>hwloc</code>, <code>libfabric</code>) as dependencies. For both <code>cuda</code> and the new <code>mpich</code> we also install "modulefiles" so the new additions are available in the typical module environment. Finally, we re-install one of the MPI benchmark applications, this time with CUDA support. <div class=highlight><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>rocky8/OpenHPC-cuda/Dockerfile</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-12-1> 1</a></span>
<span class=normal><a href=#__codelineno-12-2> 2</a></span>
<span class=normal><a href=#__codelineno-12-3> 3</a></span>
<span class=normal><a href=#__codelineno-12-4> 4</a></span>
<span class=normal><a href=#__codelineno-12-5> 5</a></span>
<span class=normal><a href=#__codelineno-12-6> 6</a></span>
<span class=normal><a href=#__codelineno-12-7> 7</a></span>
<span class=normal><a href=#__codelineno-12-8> 8</a></span>
<span class=normal><a href=#__codelineno-12-9> 9</a></span>
<span class=normal><a href=#__codelineno-12-10>10</a></span>
<span class=normal><a href=#__codelineno-12-11>11</a></span>
<span class=normal><a href=#__codelineno-12-12>12</a></span>
<span class=normal><a href=#__codelineno-12-13>13</a></span>
<span class=normal><a href=#__codelineno-12-14>14</a></span>
<span class=normal><a href=#__codelineno-12-15>15</a></span>
<span class=normal><a href=#__codelineno-12-16>16</a></span>
<span class=normal><a href=#__codelineno-12-17>17</a></span>
<span class=normal><a href=#__codelineno-12-18>18</a></span>
<span class=normal><a href=#__codelineno-12-19>19</a></span>
<span class=normal><a href=#__codelineno-12-20>20</a></span>
<span class=normal><a href=#__codelineno-12-21>21</a></span>
<span class=normal><a href=#__codelineno-12-22>22</a></span>
<span class=normal><a href=#__codelineno-12-23>23</a></span>
<span class=normal><a href=#__codelineno-12-24>24</a></span>
<span class=normal><a href=#__codelineno-12-25>25</a></span>
<span class=normal><a href=#__codelineno-12-26>26</a></span>
<span class=normal><a href=#__codelineno-12-27>27</a></span>
<span class=normal><a href=#__codelineno-12-28>28</a></span>
<span class=normal><a href=#__codelineno-12-29>29</a></span>
<span class=normal><a href=#__codelineno-12-30>30</a></span>
<span class=normal><a href=#__codelineno-12-31>31</a></span>
<span class=normal><a href=#__codelineno-12-32>32</a></span>
<span class=normal><a href=#__codelineno-12-33>33</a></span>
<span class=normal><a href=#__codelineno-12-34>34</a></span>
<span class=normal><a href=#__codelineno-12-35>35</a></span>
<span class=normal><a href=#__codelineno-12-36>36</a></span>
<span class=normal><a href=#__codelineno-12-37>37</a></span>
<span class=normal><a href=#__codelineno-12-38>38</a></span>
<span class=normal><a href=#__codelineno-12-39>39</a></span>
<span class=normal><a href=#__codelineno-12-40>40</a></span>
<span class=normal><a href=#__codelineno-12-41>41</a></span>
<span class=normal><a href=#__codelineno-12-42>42</a></span>
<span class=normal><a href=#__codelineno-12-43>43</a></span>
<span class=normal><a href=#__codelineno-12-44>44</a></span>
<span class=normal><a href=#__codelineno-12-45>45</a></span>
<span class=normal><a href=#__codelineno-12-46>46</a></span>
<span class=normal><a href=#__codelineno-12-47>47</a></span>
<span class=normal><a href=#__codelineno-12-48>48</a></span>
<span class=normal><a href=#__codelineno-12-49>49</a></span>
<span class=normal><a href=#__codelineno-12-50>50</a></span>
<span class=normal><a href=#__codelineno-12-51>51</a></span>
<span class=normal><a href=#__codelineno-12-52>52</a></span>
<span class=normal><a href=#__codelineno-12-53>53</a></span>
<span class=normal><a href=#__codelineno-12-54>54</a></span>
<span class=normal><a href=#__codelineno-12-55>55</a></span>
<span class=normal><a href=#__codelineno-12-56>56</a></span>
<span class=normal><a href=#__codelineno-12-57>57</a></span>
<span class=normal><a href=#__codelineno-12-58>58</a></span>
<span class=normal><a href=#__codelineno-12-59>59</a></span>
<span class=normal><a href=#__codelineno-12-60>60</a></span>
<span class=normal><a href=#__codelineno-12-61>61</a></span>
<span class=normal><a href=#__codelineno-12-62>62</a></span>
<span class=normal><a href=#__codelineno-12-63>63</a></span>
<span class=normal><a href=#__codelineno-12-64>64</a></span>
<span class=normal><a href=#__codelineno-12-65>65</a></span>
<span class=normal><a href=#__codelineno-12-66>66</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-12-1><a id=__codelineno-12-1 name=__codelineno-12-1></a>FROM benjaminkirk/rocky8-openhpc-mpich:latest
</span><span id=__span-12-2><a id=__codelineno-12-2 name=__codelineno-12-2></a>
</span><span id=__span-12-3><a id=__codelineno-12-3 name=__codelineno-12-3></a>ARG COMPILER_VERSION=gnu9
</span><span id=__span-12-4><a id=__codelineno-12-4 name=__codelineno-12-4></a>ARG MPI_FAMILY=mpich
</span><span id=__span-12-5><a id=__codelineno-12-5 name=__codelineno-12-5></a>ARG MPI_FAMILY_VARIANT=mpich-ofi
</span><span id=__span-12-6><a id=__codelineno-12-6 name=__codelineno-12-6></a>ARG MPICH_VERSION=3.4.3
</span><span id=__span-12-7><a id=__codelineno-12-7 name=__codelineno-12-7></a>ARG OSU_VERSION=7.2
</span><span id=__span-12-8><a id=__codelineno-12-8 name=__codelineno-12-8></a>
</span><span id=__span-12-9><a id=__codelineno-12-9 name=__codelineno-12-9></a>USER root
</span><span id=__span-12-10><a id=__codelineno-12-10 name=__codelineno-12-10></a>
</span><span id=__span-12-11><a id=__codelineno-12-11 name=__codelineno-12-11></a># https://developer.nvidia.com/cuda-11-7-1-download-archive
</span><span id=__span-12-12><a id=__codelineno-12-12 name=__codelineno-12-12></a>RUN echo &quot;Cuda&quot; \
</span><span id=__span-12-13><a id=__codelineno-12-13 name=__codelineno-12-13></a>    &amp;&amp; curl -O https://developer.download.nvidia.com/compute/cuda/11.7.1/local_installers/cuda-repo-rhel8-11-7-local-11.7.1_515.65.01-1.x86_64.rpm \
</span><span id=__span-12-14><a id=__codelineno-12-14 name=__codelineno-12-14></a>    &amp;&amp; rpm -i cuda-repo-rhel8-11-7-local-11.7.1_515.65.01-1.x86_64.rpm &amp;&amp; rm -f cuda-repo-rhel8-11-7-local-11.7.1_515.65.01-1.x86_64.rpm \
</span><span id=__span-12-15><a id=__codelineno-12-15 name=__codelineno-12-15></a>    &amp;&amp; dnf -y install cuda &amp;&amp; rm /var/cuda-repo-rhel8-11-7-local/*.rpm &amp;&amp; dnf config-manager --disable cuda-rhel8-11-7-local \
</span><span id=__span-12-16><a id=__codelineno-12-16 name=__codelineno-12-16></a>    &amp;&amp; echo &quot;RDMA prereqs&quot; \
</span><span id=__span-12-17><a id=__codelineno-12-17 name=__codelineno-12-17></a>    &amp;&amp; dnf -y install libibverbs-devel libpsm2-devel \
</span><span id=__span-12-18><a id=__codelineno-12-18 name=__codelineno-12-18></a>    &amp;&amp; docker-clean
</span><span id=__span-12-19><a id=__codelineno-12-19 name=__codelineno-12-19></a>
</span><span id=__span-12-20><a id=__codelineno-12-20 name=__codelineno-12-20></a>RUN mkdir /opt/ohpc/pub/moduledeps/${COMPILER_VERSION}/cuda
</span><span id=__span-12-21><a id=__codelineno-12-21 name=__codelineno-12-21></a>COPY extras/cuda-11.7 /opt/ohpc/pub/moduledeps/${COMPILER_VERSION}/cuda/11.7
</span><span id=__span-12-22><a id=__codelineno-12-22 name=__codelineno-12-22></a>COPY extras/mpich-${MPICH_VERSION}-ofi-cuda /opt/ohpc/pub/moduledeps/${COMPILER_VERSION}/mpich/${MPICH_VERSION}-ofi-cuda
</span><span id=__span-12-23><a id=__codelineno-12-23 name=__codelineno-12-23></a>COPY extras/hello_world.cu /home/plainuser
</span><span id=__span-12-24><a id=__codelineno-12-24 name=__codelineno-12-24></a>
</span><span id=__span-12-25><a id=__codelineno-12-25 name=__codelineno-12-25></a>RUN mkdir -p /opt/local \
</span><span id=__span-12-26><a id=__codelineno-12-26 name=__codelineno-12-26></a>    &amp;&amp; chown -R plainuser: /home/plainuser/ /opt/local
</span><span id=__span-12-27><a id=__codelineno-12-27 name=__codelineno-12-27></a>
</span><span id=__span-12-28><a id=__codelineno-12-28 name=__codelineno-12-28></a>USER plainuser
</span><span id=__span-12-29><a id=__codelineno-12-29 name=__codelineno-12-29></a>SHELL [&quot;/bin/bash&quot;, &quot;-lc&quot;]
</span><span id=__span-12-30><a id=__codelineno-12-30 name=__codelineno-12-30></a>
</span><span id=__span-12-31><a id=__codelineno-12-31 name=__codelineno-12-31></a>RUN whoami &amp;&amp; module avail \
</span><span id=__span-12-32><a id=__codelineno-12-32 name=__codelineno-12-32></a>    &amp;&amp; module load -mpich +hwloc +libfabric +cuda &amp;&amp; module list \
</span><span id=__span-12-33><a id=__codelineno-12-33 name=__codelineno-12-33></a>    &amp;&amp; cd /opt/local &amp;&amp; nvcc -o hello_cuda /home/plainuser/hello_world.cu --cudart shared \
</span><span id=__span-12-34><a id=__codelineno-12-34 name=__codelineno-12-34></a>    &amp;&amp; cd /tmp &amp;&amp; curl -sSL https://www.mpich.org/static/downloads/${MPICH_VERSION}/mpich-${MPICH_VERSION}.tar.gz | tar xz \
</span><span id=__span-12-35><a id=__codelineno-12-35 name=__codelineno-12-35></a>    &amp;&amp; cd mpich-${MPICH_VERSION} \
</span><span id=__span-12-36><a id=__codelineno-12-36 name=__codelineno-12-36></a>    &amp;&amp; ./configure --help \
</span><span id=__span-12-37><a id=__codelineno-12-37 name=__codelineno-12-37></a>    &amp;&amp; ./configure --prefix=/opt/local/mpich-${MPICH_VERSION}-cuda \
</span><span id=__span-12-38><a id=__codelineno-12-38 name=__codelineno-12-38></a>                   CC=$(which gcc) CXX=$(which g++) FC=$(which gfortran) F77=$(which gfortran) \
</span><span id=__span-12-39><a id=__codelineno-12-39 name=__codelineno-12-39></a>                   --enable-fortran \
</span><span id=__span-12-40><a id=__codelineno-12-40 name=__codelineno-12-40></a>                   --with-libfabric=${LIBFABRIC_DIR} \
</span><span id=__span-12-41><a id=__codelineno-12-41 name=__codelineno-12-41></a>                   --with-hwloc-prefix=${HWLOC_DIR} \
</span><span id=__span-12-42><a id=__codelineno-12-42 name=__codelineno-12-42></a>                   --with-cuda=${CUDA_HOME} \
</span><span id=__span-12-43><a id=__codelineno-12-43 name=__codelineno-12-43></a>    &amp;&amp; make -j 8 &amp;&amp; make install \
</span><span id=__span-12-44><a id=__codelineno-12-44 name=__codelineno-12-44></a>    &amp;&amp; docker-clean
</span><span id=__span-12-45><a id=__codelineno-12-45 name=__codelineno-12-45></a>
</span><span id=__span-12-46><a id=__codelineno-12-46 name=__codelineno-12-46></a># Prevent mpicxx from linking -lmpicxx, which we do not need, and cannot use on our Cray-EX
</span><span id=__span-12-47><a id=__codelineno-12-47 name=__codelineno-12-47></a>RUN sed -i &#39;s/cxxlibs=&quot;-lmpicxx&quot;/cxxlibs= #&quot;-lmpicxx&quot;/g&#39; /opt/local/mpich-${MPICH_VERSION}-cuda/bin/mpicxx
</span><span id=__span-12-48><a id=__codelineno-12-48 name=__codelineno-12-48></a>
</span><span id=__span-12-49><a id=__codelineno-12-49 name=__codelineno-12-49></a>RUN echo &quot;Installing MPI benchmark applications&quot; \
</span><span id=__span-12-50><a id=__codelineno-12-50 name=__codelineno-12-50></a>    &amp;&amp; whoami &amp;&amp; module avail \
</span><span id=__span-12-51><a id=__codelineno-12-51 name=__codelineno-12-51></a>    &amp;&amp; module load mpich/${MPICH_VERSION}-ofi-cuda &amp;&amp; module list \
</span><span id=__span-12-52><a id=__codelineno-12-52 name=__codelineno-12-52></a>    &amp;&amp; echo &quot;OSU:&quot; \
</span><span id=__span-12-53><a id=__codelineno-12-53 name=__codelineno-12-53></a>    &amp;&amp; cd /tmp &amp;&amp; curl -Sl https://mvapich.cse.ohio-state.edu/download/mvapich/osu-micro-benchmarks-${OSU_VERSION}.tar.gz | tar xz \
</span><span id=__span-12-54><a id=__codelineno-12-54 name=__codelineno-12-54></a>    &amp;&amp; cd osu-micro-benchmarks-${OSU_VERSION} \
</span><span id=__span-12-55><a id=__codelineno-12-55 name=__codelineno-12-55></a>    &amp;&amp; ./configure --help \
</span><span id=__span-12-56><a id=__codelineno-12-56 name=__codelineno-12-56></a>    &amp;&amp; ./configure --prefix=/opt/local/osu-micro-benchmarks-${OSU_VERSION} \
</span><span id=__span-12-57><a id=__codelineno-12-57 name=__codelineno-12-57></a>                   CXX=$(which mpicxx) CC=$(which mpicc) FC=$(which mpif90) F77=$(which mpif77) LIBS=&quot;-L${CUDA_HOME}/targets/x86_64-linux/lib -lcudart&quot; \
</span><span id=__span-12-58><a id=__codelineno-12-58 name=__codelineno-12-58></a>                   --enable-cuda --with-cuda=${CUDA_HOME} \
</span><span id=__span-12-59><a id=__codelineno-12-59 name=__codelineno-12-59></a>    &amp;&amp; make -j 8 V=0 &amp;&amp; rm -rf /opt/local/osu-micro-benchmarks-${OSU_VERSION} &amp;&amp; make install \
</span><span id=__span-12-60><a id=__codelineno-12-60 name=__codelineno-12-60></a>    &amp;&amp; cd &amp;&amp; rm -rf /tmp/osu-micro-benchmarks-${OSU_VERSION} \
</span><span id=__span-12-61><a id=__codelineno-12-61 name=__codelineno-12-61></a>    &amp;&amp; cd /opt/local &amp;&amp; mpicxx -o hello_world_mpi /home/plainuser/hello_world_mpi.C -fopenmp \
</span><span id=__span-12-62><a id=__codelineno-12-62 name=__codelineno-12-62></a>    &amp;&amp; docker-clean
</span><span id=__span-12-63><a id=__codelineno-12-63 name=__codelineno-12-63></a>
</span><span id=__span-12-64><a id=__codelineno-12-64 name=__codelineno-12-64></a># Local Variables:
</span><span id=__span-12-65><a id=__codelineno-12-65 name=__codelineno-12-65></a># mode: sh
</span><span id=__span-12-66><a id=__codelineno-12-66 name=__codelineno-12-66></a># End:
</span></code></pre></div></td></tr></table></div></p> <p><strong>Dockerfile Steps</strong></p> <ol> <li> <p>We switch back to the <code>root</code> user so we can modify the operating system installation within the image.</p> </li> <li> <p>The first <code>RUN</code> instruction installs a full CUDA development environment and some additional development packages required to build MPI later.</p> </li> <li> <p>The next <code>RUN</code> instructions install modulefiles into the image so we can access the CUDA and (upcoming) MPICH installation, and clean up file permissions. The remaining steps are executed again as our unprivileged <code>plainuser</code>.</p> </li> <li> <p>The fourth <code>RUN</code> instruction downloads, configures, and installs MPICH. The version is chosen to closely match the baseline MPICH already installed in the image and uses some of its dependencies, and we also enable CUDA support.</p> </li> <li> <p>In the final <code>RUN</code> instruction we re-install one of the MPI benchmark applications, this time with CUDA support.</p> </li> </ol> <p><strong>Discussion</strong></p> <ul> <li> <p>There are several ways to install CUDA, here we choose a "local repo" installation because it allows us to control versions, but are careful also to remove the downloaded packages after installation, freeing up 3GB+ in the image.</p> </li> <li> <p>The CUDA development environment is very large and it is difficult to separate unnecessary components, so is step increases the size of the image from ~1.2GB to 8.8GB. We leave all components in the development image, including tools we will very likely not need <em>inside</em> a container such as <code>nsight-systems</code> and <code>nsight-compute</code>. For applications built on top of this image, a user could optionally remove these components later to decrease their final image size (demonstrated next).</p> </li> </ul> <hr> <p><strong>Building the image</strong> <div class=highlight><pre><span></span><code><span id=__span-13-1><a id=__codelineno-13-1 name=__codelineno-13-1 href=#__codelineno-13-1></a><span class=go>docker build --tag &lt;dockerhub_username&gt;/rocky8-openhpc-mpich-cuda:latest .</span>
</span></code></pre></div></p> </details> <h4 id=building-fasteddy>Building FastEddy<a class=headerlink href=#building-fasteddy title="Permanent link">&para;</a></h4> <details class=example open=open> <summary>Adding FastEddy</summary> <p><div class=highlight><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>rocky8/OpenHPC-FastEddy/Dockerfile</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-14-1> 1</a></span>
<span class=normal><a href=#__codelineno-14-2> 2</a></span>
<span class=normal><a href=#__codelineno-14-3> 3</a></span>
<span class=normal><a href=#__codelineno-14-4> 4</a></span>
<span class=normal><a href=#__codelineno-14-5> 5</a></span>
<span class=normal><a href=#__codelineno-14-6> 6</a></span>
<span class=normal><a href=#__codelineno-14-7> 7</a></span>
<span class=normal><a href=#__codelineno-14-8> 8</a></span>
<span class=normal><a href=#__codelineno-14-9> 9</a></span>
<span class=normal><a href=#__codelineno-14-10>10</a></span>
<span class=normal><a href=#__codelineno-14-11>11</a></span>
<span class=normal><a href=#__codelineno-14-12>12</a></span>
<span class=normal><a href=#__codelineno-14-13>13</a></span>
<span class=normal><a href=#__codelineno-14-14>14</a></span>
<span class=normal><a href=#__codelineno-14-15>15</a></span>
<span class=normal><a href=#__codelineno-14-16>16</a></span>
<span class=normal><a href=#__codelineno-14-17>17</a></span>
<span class=normal><a href=#__codelineno-14-18>18</a></span>
<span class=normal><a href=#__codelineno-14-19>19</a></span>
<span class=normal><a href=#__codelineno-14-20>20</a></span>
<span class=normal><a href=#__codelineno-14-21>21</a></span>
<span class=normal><a href=#__codelineno-14-22>22</a></span>
<span class=normal><a href=#__codelineno-14-23>23</a></span>
<span class=normal><a href=#__codelineno-14-24>24</a></span>
<span class=normal><a href=#__codelineno-14-25>25</a></span>
<span class=normal><a href=#__codelineno-14-26>26</a></span>
<span class=normal><a href=#__codelineno-14-27>27</a></span>
<span class=normal><a href=#__codelineno-14-28>28</a></span>
<span class=normal><a href=#__codelineno-14-29>29</a></span>
<span class=normal><a href=#__codelineno-14-30>30</a></span>
<span class=normal><a href=#__codelineno-14-31>31</a></span>
<span class=normal><a href=#__codelineno-14-32>32</a></span>
<span class=normal><a href=#__codelineno-14-33>33</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-14-1><a id=__codelineno-14-1 name=__codelineno-14-1></a>FROM benjaminkirk/rocky8-openhpc-mpich-cuda:latest
</span><span id=__span-14-2><a id=__codelineno-14-2 name=__codelineno-14-2></a>
</span><span id=__span-14-3><a id=__codelineno-14-3 name=__codelineno-14-3></a>ARG MPICH_VERSION=3.4.3
</span><span id=__span-14-4><a id=__codelineno-14-4 name=__codelineno-14-4></a>
</span><span id=__span-14-5><a id=__codelineno-14-5 name=__codelineno-14-5></a>USER root
</span><span id=__span-14-6><a id=__codelineno-14-6 name=__codelineno-14-6></a>
</span><span id=__span-14-7><a id=__codelineno-14-7 name=__codelineno-14-7></a>RUN echo &quot;netcdf: serial netcdf from the base OS&quot; \
</span><span id=__span-14-8><a id=__codelineno-14-8 name=__codelineno-14-8></a>    &amp;&amp; yum -y install \
</span><span id=__span-14-9><a id=__codelineno-14-9 name=__codelineno-14-9></a>           netcdf-devel \
</span><span id=__span-14-10><a id=__codelineno-14-10 name=__codelineno-14-10></a>    &amp;&amp; echo &quot;removing unnecessary NVIDIA components to shrink container image&quot; \
</span><span id=__span-14-11><a id=__codelineno-14-11 name=__codelineno-14-11></a>    &amp;&amp; rm -rf /opt/local/nvidia /usr/local/cuda-11.7/targets/x86_64-linux/lib/*_static.a \
</span><span id=__span-14-12><a id=__codelineno-14-12 name=__codelineno-14-12></a>    &amp;&amp; docker-clean
</span><span id=__span-14-13><a id=__codelineno-14-13 name=__codelineno-14-13></a>
</span><span id=__span-14-14><a id=__codelineno-14-14 name=__codelineno-14-14></a>USER plainuser
</span><span id=__span-14-15><a id=__codelineno-14-15 name=__codelineno-14-15></a>RUN echo &quot;FastEddy - source&quot; \
</span><span id=__span-14-16><a id=__codelineno-14-16 name=__codelineno-14-16></a>    &amp;&amp; cd /opt/local &amp;&amp; git clone https://github.com/NCAR/FastEddy-model.git &amp;&amp; git clone https://github.com/NCAR/FastEddy-tutorials.git \
</span><span id=__span-14-17><a id=__codelineno-14-17 name=__codelineno-14-17></a>    &amp;&amp; cd FastEddy-model/SRC/FEMAIN \
</span><span id=__span-14-18><a id=__codelineno-14-18 name=__codelineno-14-18></a>    &amp;&amp; sed -i &#39;s/TEST_LIBS = -lm -lmpi -lstdc++ -lcurand/TEST_LIBS = -lm -lmpi -lstdc++ $(LIBS)/g&#39; Makefile \
</span><span id=__span-14-19><a id=__codelineno-14-19 name=__codelineno-14-19></a>    &amp;&amp; sed -i &#39;s/TEST_CU_LIBS = -lm -lmpi -lcurand/TEST_CU_LIBS = -lm -lmpi $(LIBS)/g&#39; Makefile \
</span><span id=__span-14-20><a id=__codelineno-14-20 name=__codelineno-14-20></a>    &amp;&amp; docker-clean
</span><span id=__span-14-21><a id=__codelineno-14-21 name=__codelineno-14-21></a>
</span><span id=__span-14-22><a id=__codelineno-14-22 name=__codelineno-14-22></a>RUN echo &quot;FastEddy - build&quot; \
</span><span id=__span-14-23><a id=__codelineno-14-23 name=__codelineno-14-23></a>    &amp;&amp; module avail &amp;&amp; module load mpich/${MPICH_VERSION}-ofi-cuda &amp;&amp; module list \
</span><span id=__span-14-24><a id=__codelineno-14-24 name=__codelineno-14-24></a>    &amp;&amp; cd /opt/local/FastEddy-model/SRC &amp;&amp; fe_inc= &amp;&amp; for d in */ */*/ ; do fe_inc=&quot;-I$(pwd)/${d} ${fe_inc}&quot; ; done \
</span><span id=__span-14-25><a id=__codelineno-14-25 name=__codelineno-14-25></a>    &amp;&amp; cd FEMAIN &amp;&amp; make \
</span><span id=__span-14-26><a id=__codelineno-14-26 name=__codelineno-14-26></a>                        INCLUDES=&quot;${fe_inc} -I${MPI_DIR}/include/ -I${CUDA_HOME}/targets/x86_64-linux/include/&quot; \
</span><span id=__span-14-27><a id=__codelineno-14-27 name=__codelineno-14-27></a>                        LIBS=&quot;-L${CUDA_HOME}/targets/x86_64-linux/lib -lcurand -lcudart -lcuda -L/usr/lib64 -lnetcdf&quot; \
</span><span id=__span-14-28><a id=__codelineno-14-28 name=__codelineno-14-28></a>    &amp;&amp; ldd ./FastEddy \
</span><span id=__span-14-29><a id=__codelineno-14-29 name=__codelineno-14-29></a>    &amp;&amp; docker-clean
</span><span id=__span-14-30><a id=__codelineno-14-30 name=__codelineno-14-30></a>
</span><span id=__span-14-31><a id=__codelineno-14-31 name=__codelineno-14-31></a># Local Variables:
</span><span id=__span-14-32><a id=__codelineno-14-32 name=__codelineno-14-32></a># mode: sh
</span><span id=__span-14-33><a id=__codelineno-14-33 name=__codelineno-14-33></a># End:
</span></code></pre></div></td></tr></table></div> <strong>Dockerfile Steps</strong></p> <ol> <li>Again we switch back to <code>root</code> for performing operating system level tasks, as our base image left us as <code>plainuser</code>.</li> <li>The first <code>RUN</code> instruction installs the development package for NetCDF - an additional application dependency not already satisfied. We also remove some particularly large CUDA components from the <em>development</em> image not required in the final <em>application</em> image.</li> <li>Then again as <code>plainuser</code>, the next <code>RUN</code> instruction downloads the FastEddy open-source variant. We make some changes to the definition of a few hard-coded <code>make</code> variables so that we can specify installation paths during linking later.</li> <li>The final <code>RUN</code> instruction then builds FastEddy. We build up and use custom <code>INCLUDE</code> and <code>LIBS</code> variables, specifying some unique paths for the particular build environment.</li> </ol> <p><strong>Discussion</strong></p> <ul> <li>When building the image locally with Docker, the space savings from step (2) are not immediately apparent. This is a result of the Docker "layer" approach: the content still exists in the base layer and is only "logically" removed by the commands listed above. The space savings is realized on the HPC system when we "pull" the image with <code>singularity</code>.</li> <li>If an even smaller container image is desired, even more components could be stripped: CUDA numerical libraries the application does not need, or even the containerized MPIs after we are done with them. As we will see next, we replace the container MPI with the host MPI at run-time, so technically no MPI is required inside the container when we are done using it for compilation.</li> </ul> <p><strong>Building the image</strong> <div class=highlight><pre><span></span><code><span id=__span-15-1><a id=__codelineno-15-1 name=__codelineno-15-1 href=#__codelineno-15-1></a><span class=go>docker build --tag &lt;dockerhub_username&gt;/rocky8-openhpc-fasteddy:latest .</span>
</span></code></pre></div></p> <p><strong>Pushing the image to Docker Hub</strong> <div class=highlight><pre><span></span><code><span id=__span-16-1><a id=__codelineno-16-1 name=__codelineno-16-1 href=#__codelineno-16-1></a><span class=go>docker push &lt;dockerhub_username&gt;/rocky8-openhpc-fasteddy:latest</span>
</span></code></pre></div></p> </details> <h3 id=running-the-container-on-derecho>Running the container on Derecho<a class=headerlink href=#running-the-container-on-derecho title="Permanent link">&para;</a></h3> <p>With the container built from the steps above (or simply pulling the resulting image from Docker Hub), we are now ready to run a sample test case on Derecho. We choose <code>Example02_CBL.in</code> from the <a href=https://fasteddytutorial.readthedocs.io/en/latest/cases/CBL.html>FastEddy Tutorial</a> and modify it to run on 24 GPUs (full steps listed <a href=https://github.com/NCAR/hpc-demos/tree/main/containers/tutorial/apptainer/FastEddy>here</a>). The PBS job script listed below shows the steps required to "bind" the host MPI into the container.</p> <details class=example open=open> <summary>Containerized FastEddy PBS Script</summary> <div class=highlight><span class=filename>run_fasteddy_container.pbs</span><pre><span></span><code><span id=__span-17-1><a id=__codelineno-17-1 name=__codelineno-17-1 href=#__codelineno-17-1></a><span class=ch>#!/bin/bash</span>
</span><span id=__span-17-2><a id=__codelineno-17-2 name=__codelineno-17-2 href=#__codelineno-17-2></a><span class=c1>#PBS -q main</span>
</span><span id=__span-17-3><a id=__codelineno-17-3 name=__codelineno-17-3 href=#__codelineno-17-3></a><span class=c1>#PBS -j oe</span>
</span><span id=__span-17-4><a id=__codelineno-17-4 name=__codelineno-17-4 href=#__codelineno-17-4></a><span class=c1>#PBS -o fasteddy_job.log</span>
</span><span id=__span-17-5><a id=__codelineno-17-5 name=__codelineno-17-5 href=#__codelineno-17-5></a><span class=c1>#PBS -l walltime=02:00:00</span>
</span><span id=__span-17-6><a id=__codelineno-17-6 name=__codelineno-17-6 href=#__codelineno-17-6></a><span class=c1>#PBS -l select=6:ncpus=64:mpiprocs=4:ngpus=4</span>
</span><span id=__span-17-7><a id=__codelineno-17-7 name=__codelineno-17-7 href=#__codelineno-17-7></a>
</span><span id=__span-17-8><a id=__codelineno-17-8 name=__codelineno-17-8 href=#__codelineno-17-8></a>module<span class=w> </span>load<span class=w> </span>ncarenv/23.09
</span><span id=__span-17-9><a id=__codelineno-17-9 name=__codelineno-17-9 href=#__codelineno-17-9></a>module<span class=w> </span>load<span class=w> </span>apptainer<span class=w> </span>gcc<span class=w> </span>cuda<span class=w> </span><span class=o>||</span><span class=w> </span><span class=nb>exit</span><span class=w> </span><span class=m>1</span>
</span><span id=__span-17-10><a id=__codelineno-17-10 name=__codelineno-17-10 href=#__codelineno-17-10></a>module<span class=w> </span>list
</span><span id=__span-17-11><a id=__codelineno-17-11 name=__codelineno-17-11 href=#__codelineno-17-11></a>
</span><span id=__span-17-12><a id=__codelineno-17-12 name=__codelineno-17-12 href=#__codelineno-17-12></a><span class=nv>nnodes</span><span class=o>=</span><span class=k>$(</span>cat<span class=w> </span><span class=si>${</span><span class=nv>PBS_NODEFILE</span><span class=si>}</span><span class=w> </span><span class=p>|</span><span class=w> </span>sort<span class=w> </span><span class=p>|</span><span class=w> </span>uniq<span class=w> </span><span class=p>|</span><span class=w> </span>wc<span class=w> </span>-l<span class=k>)</span>
</span><span id=__span-17-13><a id=__codelineno-17-13 name=__codelineno-17-13 href=#__codelineno-17-13></a><span class=nv>nranks</span><span class=o>=</span><span class=k>$(</span>cat<span class=w> </span><span class=si>${</span><span class=nv>PBS_NODEFILE</span><span class=si>}</span><span class=w> </span><span class=p>|</span><span class=w> </span>sort<span class=w> </span><span class=p>|</span><span class=w> </span>wc<span class=w> </span>-l<span class=k>)</span>
</span><span id=__span-17-14><a id=__codelineno-17-14 name=__codelineno-17-14 href=#__codelineno-17-14></a><span class=nv>nranks_per_node</span><span class=o>=</span><span class=k>$((</span><span class=si>${</span><span class=nv>nranks</span><span class=si>}</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=si>${</span><span class=nv>nnodes</span><span class=si>}</span><span class=k>))</span>
</span><span id=__span-17-15><a id=__codelineno-17-15 name=__codelineno-17-15 href=#__codelineno-17-15></a>
</span><span id=__span-17-16><a id=__codelineno-17-16 name=__codelineno-17-16 href=#__codelineno-17-16></a><span class=nv>container_image</span><span class=o>=</span><span class=s2>&quot;./rocky8-openhpc-fasteddy.sif&quot;</span>
</span><span id=__span-17-17><a id=__codelineno-17-17 name=__codelineno-17-17 href=#__codelineno-17-17></a>
</span><span id=__span-17-18><a id=__codelineno-17-18 name=__codelineno-17-18 href=#__codelineno-17-18></a>singularity<span class=w> </span><span class=se>\</span>
</span><span id=__span-17-19><a id=__codelineno-17-19 name=__codelineno-17-19 href=#__codelineno-17-19></a><span class=w>    </span>--quiet<span class=w> </span><span class=se>\</span>
</span><span id=__span-17-20><a id=__codelineno-17-20 name=__codelineno-17-20 href=#__codelineno-17-20></a><span class=w>    </span><span class=nb>exec</span><span class=w> </span><span class=se>\</span>
</span><span id=__span-17-21><a id=__codelineno-17-21 name=__codelineno-17-21 href=#__codelineno-17-21></a><span class=w>    </span><span class=si>${</span><span class=nv>container_image</span><span class=si>}</span><span class=w> </span><span class=se>\</span>
</span><span id=__span-17-22><a id=__codelineno-17-22 name=__codelineno-17-22 href=#__codelineno-17-22></a><span class=w>    </span>ldd<span class=w> </span>/opt/local/FastEddy-model/SRC/FEMAIN/FastEddy
</span><span id=__span-17-23><a id=__codelineno-17-23 name=__codelineno-17-23 href=#__codelineno-17-23></a>
</span><span id=__span-17-24><a id=__codelineno-17-24 name=__codelineno-17-24 href=#__codelineno-17-24></a>singularity<span class=w> </span><span class=se>\</span>
</span><span id=__span-17-25><a id=__codelineno-17-25 name=__codelineno-17-25 href=#__codelineno-17-25></a><span class=w>    </span>--quiet<span class=w> </span><span class=se>\</span>
</span><span id=__span-17-26><a id=__codelineno-17-26 name=__codelineno-17-26 href=#__codelineno-17-26></a><span class=w>    </span><span class=nb>exec</span><span class=w> </span><span class=se>\</span>
</span><span id=__span-17-27><a id=__codelineno-17-27 name=__codelineno-17-27 href=#__codelineno-17-27></a><span class=w>    </span>--bind<span class=w> </span><span class=si>${</span><span class=nv>SCRATCH</span><span class=si>}</span><span class=w> </span><span class=se>\</span>
</span><span id=__span-17-28><a id=__codelineno-17-28 name=__codelineno-17-28 href=#__codelineno-17-28></a><span class=w>    </span>--bind<span class=w> </span><span class=si>${</span><span class=nv>WORK</span><span class=si>}</span><span class=w> </span><span class=se>\</span>
</span><span id=__span-17-29><a id=__codelineno-17-29 name=__codelineno-17-29 href=#__codelineno-17-29></a><span class=w>    </span>--pwd<span class=w> </span><span class=k>$(</span><span class=nb>pwd</span><span class=k>)</span><span class=w> </span><span class=se>\</span>
</span><span id=__span-17-30><a id=__codelineno-17-30 name=__codelineno-17-30 href=#__codelineno-17-30></a><span class=w>    </span>--bind<span class=w> </span>/run<span class=w> </span><span class=se>\</span>
</span><span id=__span-17-31><a id=__codelineno-17-31 name=__codelineno-17-31 href=#__codelineno-17-31></a><span class=w>    </span>--bind<span class=w> </span>/opt/cray<span class=w> </span><span class=se>\</span>
</span><span id=__span-17-32><a id=__codelineno-17-32 name=__codelineno-17-32 href=#__codelineno-17-32></a><span class=w>    </span>--bind<span class=w> </span>/usr/lib64:/host/lib64<span class=w> </span><span class=se>\</span>
</span><span id=__span-17-33><a id=__codelineno-17-33 name=__codelineno-17-33 href=#__codelineno-17-33></a><span class=w>    </span>--env<span class=w> </span><span class=nv>LD_LIBRARY_PATH</span><span class=o>=</span><span class=si>${</span><span class=nv>CRAY_MPICH_DIR</span><span class=si>}</span>/lib-abi-mpich:/opt/cray/pe/lib64:<span class=si>${</span><span class=nv>LD_LIBRARY_PATH</span><span class=si>}</span>:/host/lib64<span class=w> </span><span class=se>\</span>
</span><span id=__span-17-34><a id=__codelineno-17-34 name=__codelineno-17-34 href=#__codelineno-17-34></a><span class=w>    </span>--env<span class=w> </span><span class=nv>LD_PRELOAD</span><span class=o>=</span>/opt/cray/pe/mpich/<span class=si>${</span><span class=nv>CRAY_MPICH_VERSION</span><span class=si>}</span>/gtl/lib/libmpi_gtl_cuda.so.0<span class=w> </span><span class=se>\</span>
</span><span id=__span-17-35><a id=__codelineno-17-35 name=__codelineno-17-35 href=#__codelineno-17-35></a><span class=w>    </span><span class=si>${</span><span class=nv>container_image</span><span class=si>}</span><span class=w> </span><span class=se>\</span>
</span><span id=__span-17-36><a id=__codelineno-17-36 name=__codelineno-17-36 href=#__codelineno-17-36></a><span class=w>    </span>ldd<span class=w> </span>/opt/local/FastEddy-model/SRC/FEMAIN/FastEddy
</span><span id=__span-17-37><a id=__codelineno-17-37 name=__codelineno-17-37 href=#__codelineno-17-37></a>
</span><span id=__span-17-38><a id=__codelineno-17-38 name=__codelineno-17-38 href=#__codelineno-17-38></a>
</span><span id=__span-17-39><a id=__codelineno-17-39 name=__codelineno-17-39 href=#__codelineno-17-39></a>
</span><span id=__span-17-40><a id=__codelineno-17-40 name=__codelineno-17-40 href=#__codelineno-17-40></a><span class=nb>echo</span><span class=w> </span><span class=s2>&quot;# --&gt; BEGIN execution&quot;</span><span class=p>;</span><span class=w> </span><span class=nv>tstart</span><span class=o>=</span><span class=k>$(</span>date<span class=w> </span>+%s<span class=k>)</span>
</span><span id=__span-17-41><a id=__codelineno-17-41 name=__codelineno-17-41 href=#__codelineno-17-41></a>
</span><span id=__span-17-42><a id=__codelineno-17-42 name=__codelineno-17-42 href=#__codelineno-17-42></a>mpiexec<span class=w> </span><span class=se>\</span>
</span><span id=__span-17-43><a id=__codelineno-17-43 name=__codelineno-17-43 href=#__codelineno-17-43></a><span class=w>    </span>--np<span class=w> </span><span class=si>${</span><span class=nv>nranks</span><span class=si>}</span><span class=w> </span>--ppn<span class=w> </span><span class=si>${</span><span class=nv>nranks_per_node</span><span class=si>}</span><span class=w> </span>--no-transfer<span class=w> </span><span class=se>\</span>
</span><span id=__span-17-44><a id=__codelineno-17-44 name=__codelineno-17-44 href=#__codelineno-17-44></a><span class=w>    </span>set_gpu_rank<span class=w> </span><span class=se>\</span>
</span><span id=__span-17-45><a id=__codelineno-17-45 name=__codelineno-17-45 href=#__codelineno-17-45></a><span class=w>    </span>singularity<span class=w> </span><span class=se>\</span>
</span><span id=__span-17-46><a id=__codelineno-17-46 name=__codelineno-17-46 href=#__codelineno-17-46></a><span class=w>    </span>--quiet<span class=w> </span><span class=se>\</span>
</span><span id=__span-17-47><a id=__codelineno-17-47 name=__codelineno-17-47 href=#__codelineno-17-47></a><span class=w>    </span><span class=nb>exec</span><span class=w> </span><span class=se>\</span>
</span><span id=__span-17-48><a id=__codelineno-17-48 name=__codelineno-17-48 href=#__codelineno-17-48></a><span class=w>    </span>--bind<span class=w> </span><span class=si>${</span><span class=nv>SCRATCH</span><span class=si>}</span><span class=w> </span><span class=se>\</span>
</span><span id=__span-17-49><a id=__codelineno-17-49 name=__codelineno-17-49 href=#__codelineno-17-49></a><span class=w>    </span>--bind<span class=w> </span><span class=si>${</span><span class=nv>WORK</span><span class=si>}</span><span class=w> </span><span class=se>\</span>
</span><span id=__span-17-50><a id=__codelineno-17-50 name=__codelineno-17-50 href=#__codelineno-17-50></a><span class=w>    </span>--pwd<span class=w> </span><span class=k>$(</span><span class=nb>pwd</span><span class=k>)</span><span class=w> </span><span class=se>\</span>
</span><span id=__span-17-51><a id=__codelineno-17-51 name=__codelineno-17-51 href=#__codelineno-17-51></a><span class=w>    </span>--bind<span class=w> </span>/run<span class=w> </span><span class=se>\</span>
</span><span id=__span-17-52><a id=__codelineno-17-52 name=__codelineno-17-52 href=#__codelineno-17-52></a><span class=w>    </span>--bind<span class=w> </span>/opt/cray<span class=w> </span><span class=se>\</span>
</span><span id=__span-17-53><a id=__codelineno-17-53 name=__codelineno-17-53 href=#__codelineno-17-53></a><span class=w>    </span>--bind<span class=w> </span>/usr/lib64:/host/lib64<span class=w> </span><span class=se>\</span>
</span><span id=__span-17-54><a id=__codelineno-17-54 name=__codelineno-17-54 href=#__codelineno-17-54></a><span class=w>    </span>--env<span class=w> </span><span class=nv>LD_LIBRARY_PATH</span><span class=o>=</span><span class=si>${</span><span class=nv>CRAY_MPICH_DIR</span><span class=si>}</span>/lib-abi-mpich:/opt/cray/pe/lib64:<span class=si>${</span><span class=nv>LD_LIBRARY_PATH</span><span class=si>}</span>:/host/lib64<span class=w> </span><span class=se>\</span>
</span><span id=__span-17-55><a id=__codelineno-17-55 name=__codelineno-17-55 href=#__codelineno-17-55></a><span class=w>    </span>--env<span class=w> </span><span class=nv>LD_PRELOAD</span><span class=o>=</span>/opt/cray/pe/mpich/<span class=si>${</span><span class=nv>CRAY_MPICH_VERSION</span><span class=si>}</span>/gtl/lib/libmpi_gtl_cuda.so.0<span class=w> </span><span class=se>\</span>
</span><span id=__span-17-56><a id=__codelineno-17-56 name=__codelineno-17-56 href=#__codelineno-17-56></a><span class=w>    </span>--env<span class=w> </span><span class=nv>MPICH_GPU_SUPPORT_ENABLED</span><span class=o>=</span><span class=m>1</span><span class=w> </span><span class=se>\</span>
</span><span id=__span-17-57><a id=__codelineno-17-57 name=__codelineno-17-57 href=#__codelineno-17-57></a><span class=w>    </span>--env<span class=w> </span><span class=nv>MPICH_GPU_MANAGED_MEMORY_SUPPORT_ENABLED</span><span class=o>=</span><span class=m>1</span><span class=w> </span><span class=se>\</span>
</span><span id=__span-17-58><a id=__codelineno-17-58 name=__codelineno-17-58 href=#__codelineno-17-58></a><span class=w>    </span>--env<span class=w> </span><span class=nv>MPICH_SMP_SINGLE_COPY_MODE</span><span class=o>=</span>NONE<span class=w> </span><span class=se>\</span>
</span><span id=__span-17-59><a id=__codelineno-17-59 name=__codelineno-17-59 href=#__codelineno-17-59></a><span class=w>    </span><span class=si>${</span><span class=nv>container_image</span><span class=si>}</span><span class=w> </span><span class=se>\</span>
</span><span id=__span-17-60><a id=__codelineno-17-60 name=__codelineno-17-60 href=#__codelineno-17-60></a><span class=w>    </span>/opt/local/FastEddy-model/SRC/FEMAIN/FastEddy<span class=w> </span><span class=se>\</span>
</span><span id=__span-17-61><a id=__codelineno-17-61 name=__codelineno-17-61 href=#__codelineno-17-61></a><span class=w>    </span>./Example02_CBL.in
</span><span id=__span-17-62><a id=__codelineno-17-62 name=__codelineno-17-62 href=#__codelineno-17-62></a>
</span><span id=__span-17-63><a id=__codelineno-17-63 name=__codelineno-17-63 href=#__codelineno-17-63></a><span class=nb>echo</span><span class=w> </span><span class=s2>&quot;# --&gt; END execution&quot;</span>
</span><span id=__span-17-64><a id=__codelineno-17-64 name=__codelineno-17-64 href=#__codelineno-17-64></a><span class=nb>echo</span><span class=w> </span><span class=k>$(($(</span>date<span class=w> </span>+%s<span class=k>)</span><span class=o>-</span><span class=si>${</span><span class=nv>tstart</span><span class=si>}</span><span class=k>))</span><span class=w> </span><span class=s2>&quot; elapsed seconds; </span><span class=k>$(</span>date<span class=k>)</span><span class=s2>&quot;</span>
</span></code></pre></div> <p><strong>Discussion</strong></p> <p>The <code>mpiexec</code> command is fairly standard. Note that we are using it to launch <code>singularity</code>, which in turn will start up the containerized <code>FastEddy</code> executable.</p> <p>The <code>singularity exec</code> command line is complex, so let's deconstruct it here:</p> <ul> <li> <p>We make use of the <code>--bind</code> argument first to mount familiar GLADE file systems within the container,</p> </li> <li> <p>and again to "inject" the host MPI into the container (as described <a href=../working_with_containers/#running-containerized-mpi-applications>here</a>). The <code>/run</code> directory necessity is not immediately obvious but is used by Cray-MPICH as part of the launching process.</p> </li> <li> <p>We also need to use the <code>--env</code> to set the <code>LD_LIBRARY_PATH</code> inside the image so that the application can find the proper host libraries. Recall when we built the FastEddy executable in the containerized environment it had no knowledge of these host-specific paths. Similarly, we use <code>--env</code> to set the <code>LD_PRELOAD</code> environment variable inside the container. This will cause a particular Cray-MPICH library to be loaded prior to application initialization. This step is not required for "bare metal" execution.</p> </li> <li> <p>We set some important Cray-MPICH specific <code>MPICH_*</code> environment variables as well to enable CUDA-awareness (<code>MPICH_GPU_*</code>) and work around an MPI run-time error (<code>MPICH_SMP_SINGLE_COPY_MODE</code>) that will otherwise appear.</p> </li> <li>Finally, a note on the <code>--bind /usr/lib64:/host/lib64</code> argument. Injecting the host MPI requires that some shared libraries from the host's <code>/usr/lib64</code> directory be visible inside the image. However, this path also exists inside the image and contains other libraries needed by the application. We cannot simply bind the hosts directory into the same path, doing so will mask these other libraries. So we bind the host's <code>/usr/lib64</code> into the container image at <code>/host/lib64</code>, and make sure this path is set in the <code>LD_LIBRARY_PATH</code> variable as well. Because we want these particular host libraries found as last resort (not taking precedence over similar libraries in the container, we append <code>/host/lib64</code> to the <code>LD_LIBRARY_PATH</code> search path.</li> </ul> <p>The arguments above were determined iteratively through trial and error. Such is the reality of containerized MPI applications and proprietary host MPI integration. Feel free to experiment with the PBS file, omitting some of the <code>--bind</code> and <code>--env</code> arguments and observing the resulting error message, however <strong>do NOT modify the <code>MPICH_GPU_*</code> variables</strong>, doing so may trigger a very unfortunate kernel driver bug and render the GPU compute nodes unusable.</p> <p><strong>Pulling the image</strong></p> <p>We begin with pulling the image from Docke Hub and constructing a SIF. (If you want to test your own built/pushed image, replace <code>benjaminkirk</code> with your own <code>&lt;dockerhub_username&gt;</code> as specified in the tag/push operations listed above.) <div class=highlight><pre><span></span><code><span id=__span-18-1><a id=__codelineno-18-1 name=__codelineno-18-1 href=#__codelineno-18-1></a><span class=go>derecho$ singularity pull rocky8-openhpc-fasteddy.sif docker://benjaminkirk/rocky8-openhpc-fasteddy:latest</span>
</span><span id=__span-18-2><a id=__codelineno-18-2 name=__codelineno-18-2 href=#__codelineno-18-2></a><span class=go>[...]</span>
</span><span id=__span-18-3><a id=__codelineno-18-3 name=__codelineno-18-3 href=#__codelineno-18-3></a>
</span><span id=__span-18-4><a id=__codelineno-18-4 name=__codelineno-18-4 href=#__codelineno-18-4></a><span class=go>derecho$ ls -lh rocky8-openhpc-fasteddy.sif</span>
</span><span id=__span-18-5><a id=__codelineno-18-5 name=__codelineno-18-5 href=#__codelineno-18-5></a><span class=go>-rwxr-xr-x 1 someuser ncar 3.1G Dec  5 17:08 rocky8-openhpc-fasteddy.sif</span>
</span></code></pre></div></p> <p><strong>Running the job</strong> <div class=highlight><pre><span></span><code><span id=__span-19-1><a id=__codelineno-19-1 name=__codelineno-19-1 href=#__codelineno-19-1></a><span class=go>derecho$ mkdir ./output</span>
</span><span id=__span-19-2><a id=__codelineno-19-2 name=__codelineno-19-2 href=#__codelineno-19-2></a><span class=go>derecho$ qsub -A &lt;account&gt; run_fasteddy_container.pbs</span>
</span><span id=__span-19-3><a id=__codelineno-19-3 name=__codelineno-19-3 href=#__codelineno-19-3></a><span class=go>derecho$ tail -f fasteddy_job.log</span>
</span></code></pre></div></p> </details> <!--  LocalWords:  Apptainer OpenHPC Derecho CBL FastEddy MPI Dockerfile plainuser CUDA MPICH NGC Casper Tensorflow
 --> <hr> <div class=md-source-file> <small> Last update: <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-timeago"><span class=timeago datetime=2023-12-26T21:40:45+00:00 locale=en></span></span><span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-iso_date">2023-12-26</span> <br> Created: <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-timeago"><span class=timeago datetime=2023-12-26T21:40:45+00:00 locale=en></span></span><span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-iso_date">2023-12-26</span> </small> </div> </article> </div> <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var tab,labels=set.querySelector(".tabbed-labels");for(tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script> </div> <a href=# class="md-top md-icon" data-md-component=top hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg> Back to top </a> </main> <footer class=md-footer> <nav class="md-footer__inner md-grid" aria-label> <a href=../working_with_containers/ class="md-footer__link md-footer__link--prev" aria-label="Previous: Working with Containers" rel=prev> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg> </div> <div class=md-footer__title> <span class=md-footer__direction> Previous </span> <div class=md-ellipsis> Working with Containers </div> </div> </a> <a href=../../utilities/ class="md-footer__link md-footer__link--next" aria-label="Next: Utilities" rel=next> <div class=md-footer__title> <span class=md-footer__direction> Next </span> <div class=md-ellipsis> Utilities </div> </div> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg> </div> </a> </nav> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> <div class=md-copyright__highlight> &copy; 2023 UCAR, Licensed under the <a href=https://creativecommons.org/licenses/by-sa/4.0/ >Creative Commons CC-BY-SA 4.0</a>. </div> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> <div class=md-social> <a href=https://arc.ucar.edu/ target=_blank rel=noopener title=arc.ucar.edu class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19.07 4.93C17.22 3 14.66 1.96 12 2c-2.66-.04-5.21 1-7.06 2.93C3 6.78 1.96 9.34 2 12c-.04 2.66 1 5.21 2.93 7.06C6.78 21 9.34 22.04 12 22c2.66.04 5.21-1 7.06-2.93C21 17.22 22.04 14.66 22 12c.04-2.66-1-5.22-2.93-7.07M17 12v6h-3.5v-5h-3v5H7v-6H5l7-7 7.5 7H17Z"/></svg> </a> <a href=https://ithelp.ucar.edu/plugins/servlet/desk/site/rc target=_blank rel=noopener title=ithelp.ucar.edu class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="m15.07 11.25-.9.92C13.45 12.89 13 13.5 13 15h-2v-.5c0-1.11.45-2.11 1.17-2.83l1.24-1.26c.37-.36.59-.86.59-1.41a2 2 0 0 0-2-2 2 2 0 0 0-2 2H8a4 4 0 0 1 4-4 4 4 0 0 1 4 4 3.2 3.2 0 0 1-.93 2.25M13 19h-2v-2h2M12 2A10 10 0 0 0 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10c0-5.53-4.5-10-10-10Z"/></svg> </a> <a href=https://github.com/NCAR target=_blank rel=noopener title=github.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 496 512"><!-- Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg> </a> <a href=https://join.slack.com/t/ncarhpcusergroup/shared_invite/zt-1z00napom-SU0X8CzJWVY90C2GzRvUCg target=_blank rel=noopener title=join.slack.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M94.12 315.1c0 25.9-21.16 47.06-47.06 47.06S0 341 0 315.1c0-25.9 21.16-47.06 47.06-47.06h47.06v47.06zm23.72 0c0-25.9 21.16-47.06 47.06-47.06s47.06 21.16 47.06 47.06v117.84c0 25.9-21.16 47.06-47.06 47.06s-47.06-21.16-47.06-47.06V315.1zm47.06-188.98c-25.9 0-47.06-21.16-47.06-47.06S139 32 164.9 32s47.06 21.16 47.06 47.06v47.06H164.9zm0 23.72c25.9 0 47.06 21.16 47.06 47.06s-21.16 47.06-47.06 47.06H47.06C21.16 243.96 0 222.8 0 196.9s21.16-47.06 47.06-47.06H164.9zm188.98 47.06c0-25.9 21.16-47.06 47.06-47.06 25.9 0 47.06 21.16 47.06 47.06s-21.16 47.06-47.06 47.06h-47.06V196.9zm-23.72 0c0 25.9-21.16 47.06-47.06 47.06-25.9 0-47.06-21.16-47.06-47.06V79.06c0-25.9 21.16-47.06 47.06-47.06 25.9 0 47.06 21.16 47.06 47.06V196.9zM283.1 385.88c25.9 0 47.06 21.16 47.06 47.06 0 25.9-21.16 47.06-47.06 47.06-25.9 0-47.06-21.16-47.06-47.06v-47.06h47.06zm0-23.72c-25.9 0-47.06-21.16-47.06-47.06 0-25.9 21.16-47.06 47.06-47.06h117.84c25.9 0 47.06 21.16 47.06 47.06 0 25.9-21.16 47.06-47.06 47.06H283.1z"/></svg> </a> </div> </div> </div> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <table class=md-footer-meta__inner> <colgroup> <col style="width: 10%"> <col style="width: 90%"> </colgroup> <tbody> <tr> <td valign=center> <img alt="National Science Foundation" src=https://www.nsf.gov/news/mmg/media/images/bitmaplogo_nolayers_f_e50fcd0b-607b-4271-a808-914d9c2f65dc.png height=140 width=180> </td> <td valign=center> <p style="font-size:0.75em; "> This material is based upon work supported by the National Center for Atmospheric Research, a major facility sponsored by National Science Foundation and managed by the University Corporation for Atmospheric Research. Any opinions, findings and conclusions or recommendations expressed in this material do not necessarily reflect the views of the National Science Foundation. </p> </td> </tr> </tbody> </table> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "../../../..", "features": ["search.suggest", "search.highlight", "content.tabs.link", "content.code.annotation", "content.code.annotate", "content.code.copy", "content.action.edit", "content.action.view", "navigation.footer", "navigation.indexes", "navigation.top", "navigation.path", "navigation.tracking", "search.highlight", "search.share", "search.suggest", "announce.dismiss"], "search": "../../../../assets/javascripts/workers/search.16e2a7d4.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script> <script src=../../../../assets/javascripts/bundle.5a2dcb6a.min.js></script> <script src=../../../../js/timeago.min.js></script> <script src=../../../../js/timeago_mkdocs_material.js></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML"></script> <script src=../../../../js/open_in_new_tab.js></script> <script>document$.subscribe(() => {const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});})</script></body> </html>